{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Check-In - Additional Information" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkin.css' %}">
{% endblock %}

{% block content %}
<section class="checkin-hero">
    <div class="checkin-content">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step completed">
                <span class="step-number">1</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step completed">
                <span class="step-number">2</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step active">
                <span class="step-number">3</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">4</span>
            </div>
        </div>

        <h1>üìù {% trans "Additional Information" %}</h1>
        <p>{% trans "Just a few more details to complete your check-in." %}</p>

        <!-- PIN Generation Progress (Real-time) -->
        <div id="pin-progress" class="pin-progress-box">
            <div class="progress-header">
                <span class="progress-icon">üîë</span>
                <span class="progress-text">{% trans "Preparing your access PIN..." %}</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <div class="progress-status" id="progress-status">
                <span class="status-dot"></span>
                <span id="status-text">{% trans "Generating..." %}</span>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="info-box" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444; margin-bottom: 20px;">
                    <p style="color: #dc2626; margin: 0;">{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" class="checkin-form" id="parking-form" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Parking Question -->
            <div class="parking-question">
                <label>üöó {% trans "Do You Need Parking?" %}</label>
                <div class="parking-options">
                    <label class="parking-option" id="parking-yes-option">
                        <input type="radio" name="has_car" value="yes" id="parking-yes"
                               {% if flow_data.has_car %}checked{% endif %}>
                        <span>{% trans "Yes, I Need Parking" %}</span>
                    </label>
                    <label class="parking-option" id="parking-no-option">
                        <input type="radio" name="has_car" value="no" id="parking-no"
                               {% if flow_data.has_car == False %}checked{% endif %}>
                        <span>{% trans "No, I Don't Need It" %}</span>
                    </label>
                </div>

                <!-- Car Registration (Conditional) -->
                <div id="car-reg-section" class="car-reg-input {% if flow_data.has_car %}visible{% endif %}">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="car_registration">{% trans "Car Registration" %}</label>
                        <input type="text"
                               name="car_registration"
                               id="car_registration"
                               placeholder="{% trans 'AB12 CDE' %}"
                               value="{{ flow_data.car_registration|default:'' }}"
                               maxlength="10"
                               style="text-transform: uppercase;">
                        <small>{% trans "UK format: AB12 CDE" %}</small>
                    </div>
                </div>
            </div>

            <!-- Parking Instructions Info Box (only shown when Yes is selected) -->
            <div id="parking-info" class="info-box" style="display: {% if flow_data.has_car %}block{% else %}none{% endif %};">
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 700;">
                    üìç {% trans "Parking Instructions" %}
                </h3>
                <ul style="text-align: left; margin: 0; padding-left: 20px; color: #475569; line-height: 1.8;">
                    <li>{% trans "Free on-street parking available" %}</li>
                    <li>{% trans "Park directly in front of the building" %}</li>
                    <li>{% trans "No permit required" %}</li>
                    <li>{% trans "24/7 access to your vehicle" %}</li>
                </ul>
            </div>

            <!-- ID Upload Section -->
            <div class="id-upload-section">
                <label>üì∏ {% trans "ID Upload" %} <span style="font-weight: 400; color: #64748b;">({% trans "optional" %})</span></label>
                <p>{% trans "Upload a photo of your ID or passport. This helps us verify your identity." %}</p>

                <!-- Upload Method Selection -->
                <div class="upload-methods" id="upload-buttons">
                    <button type="button" class="upload-btn" id="camera-btn">
                        <span class="btn-icon">üì∑</span>
                        <span class="btn-text">{% trans "Take Photo" %}</span>
                    </button>
                    <button type="button" class="upload-btn" id="gallery-btn">
                        <span class="btn-icon">üñºÔ∏è</span>
                        <span class="btn-text">{% trans "Upload from Gallery" %}</span>
                    </button>
                </div>

                <!-- Hidden File Inputs -->
                <input type="file"
                       name="id_image"
                       id="camera-input"
                       accept="image/*"
                       capture="environment"
                       style="display: none;">
                <input type="file"
                       name="id_image_gallery"
                       id="gallery-input"
                       accept="image/*"
                       style="display: none;">

                <!-- Image Preview -->
                <div id="image-preview" style="display: none;">
                    <div class="preview-container">
                        <img id="preview-img" src="" alt="{% trans 'ID Preview' %}">
                        <button type="button" class="remove-btn" id="remove-image">
                            ‚úï {% trans "Remove" %}
                        </button>
                    </div>
                    <p style="font-size: 14px; color: #10b981; margin-top: 12px; font-weight: 600;">
                        ‚úì {% trans "ID uploaded successfully!" %}
                    </p>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary" id="continue-btn">
                {% trans "Continue" %} ‚Üí
            </button>
        </form>

        <!-- Back Link -->
        <p style="text-align: center;">
            <a href="{% url 'checkin_details' %}" class="back-link">‚Üê {% trans "Back" %}</a>
        </p>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // ========================
        // Parking Question Logic
        // ========================
        const parkingYes = document.getElementById('parking-yes');
        const parkingNo = document.getElementById('parking-no');
        const carRegSection = document.getElementById('car-reg-section');
        const parkingInfo = document.getElementById('parking-info');
        const carRegInput = document.getElementById('car_registration');
        const parkingYesOption = document.getElementById('parking-yes-option');
        const parkingNoOption = document.getElementById('parking-no-option');

        function updateParkingUI() {
            if (parkingYes.checked) {
                carRegSection.classList.add('visible');
                parkingInfo.style.display = 'block';
                parkingYesOption.style.borderColor = '#0066cc';
                parkingYesOption.style.background = 'linear-gradient(135deg, rgba(0, 102, 204, 0.1) 0%, rgba(0, 102, 204, 0.05) 100%)';
                parkingNoOption.style.borderColor = '#e2e8f0';
                parkingNoOption.style.background = '#f8fafc';
            } else {
                carRegSection.classList.remove('visible');
                parkingInfo.style.display = 'none';
                carRegInput.value = ''; // Clear the input
                parkingNoOption.style.borderColor = '#0066cc';
                parkingNoOption.style.background = 'linear-gradient(135deg, rgba(0, 102, 204, 0.1) 0%, rgba(0, 102, 204, 0.05) 100%)';
                parkingYesOption.style.borderColor = '#e2e8f0';
                parkingYesOption.style.background = '#f8fafc';
            }
        }

        // Initialize on page load
        updateParkingUI();

        parkingYes.addEventListener('change', updateParkingUI);
        parkingNo.addEventListener('change', updateParkingUI);

        // ========================
        // ID Upload Functionality
        // ========================
        const cameraBtn = document.getElementById('camera-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        const cameraInput = document.getElementById('camera-input');
        const galleryInput = document.getElementById('gallery-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeBtn = document.getElementById('remove-image');
        const uploadButtons = document.getElementById('upload-buttons');

        let selectedFile = null;

        cameraBtn.addEventListener('click', function() {
            cameraInput.click();
        });

        galleryBtn.addEventListener('click', function() {
            galleryInput.click();
        });

        cameraInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });

        galleryInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('{% trans "Please select an image file (JPG, PNG, etc.)" %}');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('{% trans "Image must be under 5MB" %}');
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                uploadButtons.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        removeBtn.addEventListener('click', function() {
            selectedFile = null;
            cameraInput.value = '';
            galleryInput.value = '';
            imagePreview.style.display = 'none';
            uploadButtons.style.display = 'grid';
        });

        // ===================================
        // Real-time PIN Generation Progress
        // ===================================
        const progressFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('status-text');
        const pinProgressBox = document.getElementById('pin-progress');
        const statusDot = document.querySelector('.status-dot');

        let progress = 0;
        let checkInterval;

        function updateProgress() {
            if (progress < 95) {
                progress += Math.random() * 10;
                if (progress > 95) progress = 95;
                progressFill.style.width = progress + '%';
            }
        }

        function checkPINStatus() {
            fetch('/checkin/pin-status/')
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        progress = 100;
                        progressFill.style.width = '100%';
                        statusText.textContent = '{% trans "Ready!" %}';
                        statusText.style.color = '#10b981';
                        pinProgressBox.classList.add('ready');
                        statusDot.style.background = '#10b981';
                        statusDot.style.animation = 'none';
                        clearInterval(checkInterval);
                    } else if (data.failed) {
                        statusText.textContent = '{% trans "Failed - Please contact support" %}';
                        statusText.style.color = '#ef4444';
                        pinProgressBox.style.borderColor = '#ef4444';
                        clearInterval(checkInterval);
                    } else {
                        updateProgress();
                    }
                })
                .catch(error => {
                    console.error('Error checking PIN status:', error);
                });
        }

        checkInterval = setInterval(checkPINStatus, 1500);
        checkPINStatus();

        // Form submission
        const form = document.getElementById('parking-form');
        form.addEventListener('submit', function(e) {
            const continueBtn = document.getElementById('continue-btn');
            continueBtn.disabled = true;
            continueBtn.innerHTML = '<span class="spinner"></span> {% trans "Processing..." %}';
        });
    });
</script>
{% endblock %}
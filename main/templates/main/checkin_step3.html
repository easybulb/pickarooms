{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Check-In - Parking Information" %}{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step completed">
                <span class="step-number">1</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step completed">
                <span class="step-number">2</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step active">
                <span class="step-number">3</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">4</span>
            </div>
        </div>

        <h1>üìù {% trans "Additional Information" %}</h1>
        <p style="font-size: 14px; color: #ccc; margin-bottom: 15px;">
            {% trans "Just a few more details to complete your check-in." %}
        </p>

        <!-- PIN Generation Progress (Real-time) -->
        <div id="pin-progress" class="pin-progress-box">
            <div class="progress-header">
                <span class="progress-icon">üîë</span>
                <span class="progress-text">{% trans "Preparing your access PIN..." %}</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <div class="progress-status" id="progress-status">
                <span class="status-dot"></span>
                <span id="status-text">{% trans "Generating..." %}</span>
            </div>
        </div>

        <form method="post" class="checkin-form" id="parking-form" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Car Yes/No -->
            <div class="form-group">
                <label>{% trans "Are you arriving by car?" %} *</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="has_car" value="yes" id="car-yes" 
                               {% if flow_data.has_car %}checked{% endif %}>
                        <span class="radio-label">
                            <span class="radio-icon">üöó</span>
                            {% trans "Yes, I'm driving" %}
                        </span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="has_car" value="no" id="car-no"
                               {% if flow_data.has_car == False %}checked{% endif %}>
                        <span class="radio-label">
                            <span class="radio-icon">üöá</span>
                            {% trans "No, other transport" %}
                        </span>
                    </label>
                </div>
            </div>

            <!-- Car Registration (Conditional) -->
            <div id="car-details" style="display: none;">
                <div class="form-group">
                    <label for="car_registration">{% trans "Car Registration" %}</label>
                    <input type="text" 
                           name="car_registration" 
                           id="car_registration"
                           placeholder="{% trans 'AB12 CDE' %}"
                           value="{{ flow_data.car_registration|default:'' }}"
                           maxlength="10"
                           style="text-transform: uppercase;">
                    <small style="color: #ccc; font-size: 12px; display: block; margin-top: 5px;">
                        {% trans "UK format: AB12 CDE" %}
                    </small>
                </div>

                <!-- Parking Instructions -->
                <div class="info-box">
                    <h3>üìç {% trans "Parking Instructions" %}</h3>
                    <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                        <li>{% trans "Free on-street parking available" %}</li>
                        <li>{% trans "Park directly in front of the building" %}</li>
                        <li>{% trans "No permit required" %}</li>
                        <li>{% trans "24/7 access to your vehicle" %}</li>
                    </ul>
                </div>
            </div>

            <!-- ID Upload Section (Optional) -->
            <div class="form-group" style="margin-top: 30px;">
                <label>üì∏ {% trans "ID Upload" %} ({% trans "optional" %})</label>
                <p style="font-size: 13px; color: #ccc; margin-bottom: 15px;">
                    {% trans "Upload a photo of your ID or passport. This helps us verify your identity." %}
                </p>

                <!-- Upload Method Selection -->
                <div class="upload-methods">
                    <button type="button" class="upload-btn camera-btn" id="camera-btn">
                        <span class="btn-icon">üì∑</span>
                        <span class="btn-text">{% trans "Take Photo" %}</span>
                    </button>
                    <button type="button" class="upload-btn gallery-btn" id="gallery-btn">
                        <span class="btn-icon">üñºÔ∏è</span>
                        <span class="btn-text">{% trans "Upload from Gallery" %}</span>
                    </button>
                </div>

                <!-- Hidden File Inputs -->
                <input type="file"
                       name="id_image"
                       id="camera-input"
                       accept="image/*"
                       capture="environment"
                       style="display: none;">
                <input type="file"
                       name="id_image_gallery"
                       id="gallery-input"
                       accept="image/*"
                       style="display: none;">

                <!-- Image Preview -->
                <div id="image-preview" style="display: none; margin-top: 15px;">
                    <div class="preview-container">
                        <img id="preview-img" src="" alt="{% trans 'ID Preview' %}">
                        <button type="button" class="remove-btn" id="remove-image">
                            <span>‚úï</span> {% trans "Remove" %}
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #28a745; margin-top: 10px;">
                        ‚úì {% trans "ID uploaded successfully!" %}
                    </p>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary" id="continue-btn">
                {% trans "Continue" %} ‚Üí
            </button>
        </form>

        <!-- Back Link -->
        <p style="margin-top: 15px;">
            <a href="{% url 'checkin_details' %}" class="back-link">‚Üê {% trans "Back" %}</a>
        </p>

        <!-- Hidden message: PIN is generating in background -->
        <div id="background-notice" style="display: none; margin-top: 20px; padding: 10px; background: rgba(102, 126, 234, 0.2); border-radius: 5px; font-size: 13px; color: #ccc;">
            <span class="spinner"></span>
            {% trans "Your access PIN is being prepared in the background..." %}
        </div>
    </div>
    <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739380781/grey-hero-pickarooms_i5lums.png"
         alt="{% trans 'Luxury Hotel Room' %}" class="hero-image">
</section>

<style>
    /* Progress Bar Styles (same as step2) */
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #fff;
        position: relative;
        transition: all 0.3s ease;
    }

    .step.completed {
        background: #28a745;
        border-color: #28a745;
    }

    .step.active {
        background: #667eea;
        border-color: #667eea;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
    }

    .step .step-number {
        display: block;
    }

    .step.completed .step-number {
        display: none;
    }

    .step .checkmark {
        display: none;
        font-size: 20px;
    }

    .step.completed .checkmark {
        display: block;
    }

    .step-line {
        width: 60px;
        height: 3px;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .step-line.completed {
        background: #28a745;
    }

    /* Radio Group Styles */
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .radio-option {
        display: block;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .radio-option:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }

    .radio-option input[type="radio"] {
        margin-right: 10px;
    }

    .radio-option input[type="radio"]:checked + .radio-label {
        font-weight: bold;
    }

    .radio-option:has(input:checked) {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.2);
    }

    .radio-label {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
        font-size: 16px;
    }

    .radio-icon {
        font-size: 24px;
    }

    /* Info Box */
    .info-box {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        color: #fff;
    }

    .info-box h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #FFD700;
    }

    .info-box ul {
        margin: 0;
        padding-left: 20px;
        font-size: 14px;
        line-height: 1.8;
    }

    .info-box li {
        color: #ccc;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #444;
        border-radius: 5px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
    }

    .btn-primary {
        width: 100%;
        padding: 14px;
        border: none;
        background: linear-gradient(90deg, #002147, #003580, #0056b3);
        color: white;
        font-size: 16px;
        font-weight: 600;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 86, 179, 0.4);
    }

    .back-link {
        color: #FFD700;
        text-decoration: none;
        font-size: 14px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    /* PIN Progress Box */
    .pin-progress-box {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        border: 2px solid rgba(102, 126, 234, 0.4);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 15px rgba(102, 126, 234, 0.3); }
        50% { box-shadow: 0 0 25px rgba(102, 126, 234, 0.5); }
    }

    .progress-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }

    .progress-icon {
        font-size: 24px;
        animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .progress-text {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
    }

    .progress-bar-track {
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
        background-size: 200% 100%;
        border-radius: 10px;
        width: 0%;
        transition: width 0.5s ease;
        animation: shimmer 2s linear infinite;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .progress-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #ccc;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        background: #667eea;
        border-radius: 50%;
        animation: blink 1.5s ease-in-out infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    /* Upload Methods */
    .upload-methods {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .upload-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px 15px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #fff;
    }

    .upload-btn:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.15);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .upload-btn .btn-icon {
        font-size: 32px;
    }

    .upload-btn .btn-text {
        font-size: 14px;
        font-weight: 500;
    }

    /* Image Preview */
    .preview-container {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #28a745;
        background: rgba(0, 0, 0, 0.5);
    }

    .preview-container img {
        width: 100%;
        max-height: 300px;
        object-fit: contain;
        display: block;
    }

    .remove-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .remove-btn:hover {
        background: #dc3545;
        transform: scale(1.05);
    }

    /* Spinner */
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .progress-bar {
            max-width: 100%;
            padding: 0 20px;
        }

        .step {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }

        .step-line {
            width: 40px;
        }

        .hero-content h1 {
            font-size: 2rem;
        }

        .radio-label {
            font-size: 14px;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const carYes = document.getElementById('car-yes');
        const carNo = document.getElementById('car-no');
        const carDetails = document.getElementById('car-details');
        const carRegInput = document.getElementById('car_registration');
        const continueBtn = document.getElementById('continue-btn');

        // Show/hide car details based on selection
        function toggleCarDetails() {
            if (carYes.checked) {
                carDetails.style.display = 'block';
                carRegInput.focus();
            } else {
                carDetails.style.display = 'none';
            }
        }

        // Initialize on page load
        toggleCarDetails();

        carYes.addEventListener('change', toggleCarDetails);
        carNo.addEventListener('change', toggleCarDetails);

        // Auto-format car registration (UK format: AB12 CDE)
        if (carRegInput) {
            carRegInput.addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // UK format: AB12 CDE (letters-numbers-letters)
                if (value.length > 4) {
                    value = value.slice(0, 4) + ' ' + value.slice(4, 7);
                }
                
                e.target.value = value.trim();
            });
        }

        // Ensure at least one radio is selected
        const form = document.getElementById('parking-form');
        form.addEventListener('submit', function(e) {
            if (!carYes.checked && !carNo.checked) {
                e.preventDefault();
                alert('Please select whether you are arriving by car.');
                return false;
            }
        });

        // Page enter animation
        document.body.style.opacity = '0';
        setTimeout(() => {
            document.body.style.transition = 'opacity 0.3s ease';
            document.body.style.opacity = '1';
        }, 50);

        // Show background notice after 2 seconds (subtle hint that PIN is generating)
        setTimeout(() => {
            const notice = document.getElementById('background-notice');
            if (notice) {
                notice.style.display = 'block';
            }
        }, 2000);

        // ========================
        // ID Upload Functionality
        // ========================
        const cameraBtn = document.getElementById('camera-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        const cameraInput = document.getElementById('camera-input');
        const galleryInput = document.getElementById('gallery-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeBtn = document.getElementById('remove-image');

        let selectedFile = null;

        // Camera button click
        cameraBtn.addEventListener('click', function() {
            cameraInput.click();
        });

        // Gallery button click
        galleryBtn.addEventListener('click', function() {
            galleryInput.click();
        });

        // Handle camera input
        cameraInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0], 'camera');
        });

        // Handle gallery input
        galleryInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0], 'gallery');
        });

        function handleFileSelect(file, source) {
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file (JPG, PNG, etc.)');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be under 5MB');
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';

                // Hide upload buttons after selection
                document.querySelector('.upload-methods').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Remove image
        removeBtn.addEventListener('click', function() {
            selectedFile = null;
            cameraInput.value = '';
            galleryInput.value = '';
            imagePreview.style.display = 'none';
            document.querySelector('.upload-methods').style.display = 'grid';
        });

        // ===================================
        // Real-time PIN Generation Progress
        // ===================================
        const progressFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('status-text');
        const pinProgressBox = document.getElementById('pin-progress');

        let progress = 0;
        let checkInterval;

        // Simulate progress (smooth animation)
        function updateProgress() {
            if (progress < 95) {
                progress += Math.random() * 10;
                if (progress > 95) progress = 95; // Cap at 95% until confirmed
                progressFill.style.width = progress + '%';
            }
        }

        // Check PIN status via AJAX
        function checkPINStatus() {
            fetch('/checkin/pin-status/')
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        // PIN is ready!
                        progress = 100;
                        progressFill.style.width = '100%';
                        statusText.textContent = '{% trans "Ready!" %}';
                        statusText.style.color = '#28a745';
                        pinProgressBox.style.borderColor = '#28a745';
                        pinProgressBox.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1))';
                        clearInterval(checkInterval);
                    } else if (data.failed) {
                        // PIN generation failed
                        statusText.textContent = '{% trans "Failed - Please contact support" %}';
                        statusText.style.color = '#dc3545';
                        pinProgressBox.style.borderColor = '#dc3545';
                        clearInterval(checkInterval);
                    } else {
                        // Still generating
                        updateProgress();
                    }
                })
                .catch(error => {
                    console.error('Error checking PIN status:', error);
                });
        }

        // Start checking PIN status every 1.5 seconds
        checkInterval = setInterval(checkPINStatus, 1500);

        // Initial check
        checkPINStatus();
    });
</script>
{% endblock %}

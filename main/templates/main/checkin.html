{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Check-In" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkin.css' %}">
{% endblock %}

{% block content %}
<section class="checkin-hero">
    <div class="checkin-content">
        <!-- Progress Bar (Step 1) -->
        <div class="progress-bar">
            <div class="step active">
                <span class="step-number">1</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">2</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">3</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">4</span>
            </div>
        </div>

        <h1>{% trans "Check-In" %}</h1>
        <p>{% trans "Enter your booking reference to begin check-in." %}</p>

        <div class="input-area">
            {% if messages %}
                {% for message in messages %}
                    <div class="info-box" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444; margin-bottom: 20px;">
                        <p style="color: #dc2626; margin: 0; font-weight: 600;">{{ message }}</p>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" class="checkin-form" id="step1-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="reservation_number">{% trans "Booking Reference" %} *</label>
                    <input type="text"
                           name="reservation_number"
                           id="reservation_number"
                           placeholder="{% trans '1234567890' %}"
                           value="{{ reservation_number|default:'' }}"
                           inputmode="numeric"
                           pattern="[0-9]{10}"
                           maxlength="10"
                           required
                           autofocus>
                    <small>{% trans "10-digit number from your Booking.com confirmation" %}</small>
                </div>

                <button type="submit" id="continue-btn" class="btn-primary">
                    {% trans "Continue" %} →
                </button>
            </form>
        </div>

        <!-- Links for Popups -->
        <p style="text-align: center; margin-top: 20px; font-size: 14px;">
            <a href="#" id="open-how-to-use-modal" style="color: #e2e8f0; text-decoration: none; font-weight: 600;">{% trans "How to Use" %}</a>
            <span style="color: rgba(255,255,255,0.3); margin: 0 8px;">|</span>
            <a href="#" id="open-contact-modal" style="color: #e2e8f0; text-decoration: none; font-weight: 600;">{% trans "Contact Us" %}</a>
        </p>

        <!-- How to Use Modal -->
        <div id="how-to-use-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" data-modal="how-to-use-modal">×</span>
                <h2>{% trans "How to Use" %}</h2>
                <p><strong>{% trans "Step 1:" %}</strong> {% trans "Enter the confirmation number you received during your reservation on Booking.com." %}</p>
                <p><strong>{% trans "Step 2:" %}</strong> {% trans "Retrieve your PIN." %}</p>
                <p><strong>{% trans "Step 3:" %}</strong> {% trans "Follow the check-in instructions." %}</p>
                <p><strong>{% trans "Step 4:" %}</strong> {% trans "Enjoy your stay!" %}</p>
            </div>
        </div>

        <!-- Contact Us Modal -->
        <div id="contact-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" data-modal="contact-modal">×</span>
                <h2>{% trans "Contact Us" %}</h2>
                <p><strong>{% trans "Phone:" %}</strong> +44 (0) 7539029629</p>
                <p><strong>{% trans "Whatsapp:" %}</strong> +44 (0) 7539029629</p>
                <p><strong>{% trans "Email:" %}</strong> <a href="mailto:easybulb@gmail.com">easybulb@gmail.com</a></p>
            </div>
        </div>
    </div>
</section>

<!-- FAQ Section -->
<section style="background: #f8fafc; padding: 60px 20px;">
    <div style="max-width: 900px; margin: 0 auto;">
        <h2 style="text-align: center; color: #1e293b; margin-bottom: 40px; font-size: 28px; font-weight: 700;">{% trans "Have Questions? Answers Below." %}</h2>
        <div class="faq-container">
            <div class="faq-item">
                <button class="faq-question">{% trans "Where can I find my Booking.com confirmation number?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "Your Booking.com confirmation number can be found in your email and phone confirmation. You can also locate it by logging into your Booking.com account online. If using a browser, it appears at the top-right (see first image). If using the Booking.com app, it is displayed under your completed booking details (see second image)." %}</p>

                    <div class="faq-images">
                        <div class="faq-image">
                            <h3>{% trans "Using Browser" %}</h3>
                            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739476501/booking.browser_pmzfnq.png"
                                 alt="{% trans 'Booking.com confirmation number on browser' %}">
                        </div>
                        <div class="faq-image">
                            <h3>{% trans "On Booking.com App" %}</h3>
                            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739476501/booking-app_xbqadd.png"
                                 alt="{% trans 'Booking.com confirmation number on app' %}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "What is the property address?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    {% blocktrans %}<strong>8 Rylance Street, Beswick, Manchester, M11 3NP, United Kingdom</strong>{% endblocktrans %}

                    <div class="faq-map-container">
                        <iframe width="600" height="350" frameborder="0" style="border:0;" allowfullscreen="" loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade"
                                src="https://www.google.com/maps/embed/v1/place?q=8+Rylance+Street,+Beswick,+Manchester,+M11+3NP,+United+Kingdom&key={{ GOOGLE_MAPS_API_KEY }}">
                        </iframe>
                    </div>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "What are the check-in and check-out times?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>
                    {% trans "Check-in:" %} <strong>{% trans "From 2:00 PM" %}</strong> <br>
                    {% trans "Check-out:" %} <strong>{% trans "Anytime before 11:00 AM on the checkout day" %}</strong>
                    </p>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "How do I get my room access PIN?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "Your room access PIN can be found on this site after check-in with your Booking.com confirmation number." %}</p>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "Is there parking available at the property?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "Yes, free parking is available on the property. Additional paid parking options are nearby." %}</p>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "How can I contact support if I need help?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "For assistance, contact us via:" %} <br>
                        <strong>{% trans "Phone:" %}</strong> +44 (0) 7539029629 <br>
                        <strong>{% trans "Email:" %}</strong> <a href="mailto:easybulb@gmail.com">easybulb@gmail.com</a></p>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "What is your cancellation policy?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "Cancellations depend on the policy selected during booking. Check your Booking.com reservation for details." %}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Booking reference validation and formatting
        const bookingInput = document.getElementById('reservation_number');
        const continueBtn = document.getElementById('continue-btn');

        if (bookingInput && continueBtn) {
            bookingInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value;

                const isValid = value.length === 10;

                if (value.length > 0) {
                    if (isValid) {
                        e.target.style.borderColor = '#10b981';
                        e.target.style.background = 'rgba(16, 185, 129, 0.05)';
                    } else {
                        e.target.style.borderColor = '#ef4444';
                        e.target.style.background = 'rgba(239, 68, 68, 0.05)';
                    }
                } else {
                    e.target.style.borderColor = '#e2e8f0';
                    e.target.style.background = '#ffffff';
                }
            });
        }

        // Rate Limiting
        const maxAttempts = 6;
        const timeWindow = 60 * 1000;
        let attempts = JSON.parse(localStorage.getItem('checkinAttempts')) || [];

        function updateAttempts() {
            localStorage.setItem('checkinAttempts', JSON.stringify(attempts));
        }

        const now = Date.now();
        attempts = attempts.filter(time => now - time < timeWindow);
        if (attempts.length >= maxAttempts) {
            bookingInput.disabled = true;
            continueBtn.disabled = true;
            alert("{% trans 'Too many attempts, please wait for 1 minute and try again.' %}");
            setTimeout(() => {
                attempts = [];
                updateAttempts();
                bookingInput.disabled = false;
                continueBtn.disabled = false;
            }, timeWindow - (now - attempts[0]));
        }
        updateAttempts();

        document.getElementById('step1-form').addEventListener('submit', function(event) {
            const now = Date.now();
            attempts = attempts.filter(time => now - time < timeWindow);

            if (attempts.length >= maxAttempts) {
                event.preventDefault();
                bookingInput.disabled = true;
                continueBtn.disabled = true;
                alert("{% trans 'Too many attempts, please wait a moment.' %}");

                setTimeout(() => {
                    attempts = [];
                    updateAttempts();
                    bookingInput.disabled = false;
                    continueBtn.disabled = false;
                }, timeWindow - (now - attempts[0]));
            } else {
                attempts.push(now);
                updateAttempts();
            }
        });

        // Modal Functionality
        const modals = document.querySelectorAll(".modal");
        const openHowToUseBtn = document.getElementById("open-how-to-use-modal");
        const openContactBtn = document.getElementById("open-contact-modal");
        const closeModalBtns = document.querySelectorAll(".close");

        modals.forEach(modal => modal.style.display = "none");

        openHowToUseBtn.addEventListener("click", function (event) {
            event.preventDefault();
            document.getElementById("how-to-use-modal").style.display = "flex";
        });

        openContactBtn.addEventListener("click", function (event) {
            event.preventDefault();
            document.getElementById("contact-modal").style.display = "flex";
        });

        closeModalBtns.forEach(btn => {
            btn.addEventListener("click", function () {
                document.getElementById(btn.getAttribute("data-modal")).style.display = "none";
            });
        });

        window.addEventListener("click", function (event) {
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        });

        // FAQ Toggle
        const faqQuestions = document.querySelectorAll(".faq-question");

        faqQuestions.forEach(question => {
            question.addEventListener("click", function (event) {
                event.preventDefault();
                const item = question.closest(".faq-item");
                const answer = item.querySelector(".faq-answer");
                const arrow = question.querySelector(".arrow");
                const isExpanded = answer.style.display === "block";

                // Close all others
                document.querySelectorAll(".faq-item").forEach(faq => {
                    const otherAnswer = faq.querySelector(".faq-answer");
                    const otherArrow = faq.querySelector(".arrow");
                    otherAnswer.style.display = "none";
                    otherArrow.textContent = "▼";
                });

                // Toggle current
                answer.style.display = isExpanded ? "none" : "block";
                arrow.textContent = isExpanded ? "▼" : "▲";
            });
        });
    });
</script>
{% endblock %}
{% extends 'main/admin_base.html' %}
{% load static i18n %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/price_suggester.css' %}">
<style>
    .view-toggle {
        margin: 20px 0;
        text-align: right;
    }

    .view-toggle-btn {
        padding: 10px 20px;
        margin-left: 10px;
        border: 2px solid #3498db;
        background: white;
        color: #3498db;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .view-toggle-btn.active {
        background: #3498db;
        color: white;
    }

    .view-toggle-btn:hover {
        background: #3498db;
        color: white;
    }

    .suggestion-item {
        border-left: 6px solid #ccc;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: transform 0.2s;
    }

    .suggestion-item:hover {
        transform: translateX(5px);
    }

    .suggestion-item.color-red {
        border-left-color: #e74c3c;
        background: #fee;
    }

    .suggestion-item.color-orange {
        border-left-color: #e67e22;
        background: #fef4e8;
    }

    .suggestion-item.color-yellow {
        border-left-color: #f39c12;
        background: #fefbe8;
    }

    .suggestion-item.color-green {
        border-left-color: #27ae60;
        background: #efffee;
    }

    .popularity-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
    }

    .popularity-badge.red {
        background: #e74c3c;
        color: white;
    }

    .popularity-badge.orange {
        background: #e67e22;
        color: white;
    }

    .popularity-badge.yellow {
        background: #f39c12;
        color: white;
    }

    .popularity-badge.green {
        background: #27ae60;
        color: white;
    }

    .sold-out-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #c0392b;
        color: white;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
    }

    #calendar {
        max-width: 1200px;
        margin: 40px auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .event-link {
        color: inherit;
        text-decoration: none;
    }

    .event-link:hover {
        text-decoration: underline;
    }

    .info-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .info-banner h3 {
        margin-top: 0;
        font-size: 1.2em;
    }

    .view-details-btn {
        display: inline-block;
        padding: 8px 16px;
        background: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.9em;
        margin-top: 10px;
        transition: background 0.3s;
    }

    .view-details-btn:hover {
        background: #2980b9;
        color: white;
        text-decoration: none;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .view-toggle {
            text-align: center;
        }

        .view-toggle-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
        }

        .legend {
            flex-wrap: wrap;
        }

        #calendar {
            padding: 10px;
        }
    }

    /* Calendar sold-out event styling */
    .sold-out-event {
        text-decoration: line-through;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block title %}{% trans "Price Suggester" %}{% endblock %}

{% block admin_content %}
    <h1 class="page-header-title">üí∞ {% trans "Price Suggester" %}</h1>
    <p class="page-subtitle">{% trans "Automated event tracking with SMS alerts for important events" %}</p>

    <p style="text-align: center; font-size: 1.1em; margin: 20px 0; color: white;">
        <strong>Total events tracked:</strong> {{ total_elements }}
    </p>

    <!-- View Toggle: Priority Venues vs All Manchester -->
    <div class="view-toggle" id="view-toggle-section">
        <a href="?filter=priority&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}&show_sold_out={{ show_sold_out }}#view-toggle-section"
           class="view-toggle-btn {% if venue_filter == 'priority' %}active{% endif %}">
            ‚≠ê Priority Venues
        </a>
        <a href="?filter=all&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}&show_sold_out={{ show_sold_out }}#view-toggle-section"
           class="view-toggle-btn {% if venue_filter == 'all' %}active{% endif %}">
            üèõÔ∏è All Manchester
        </a>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c;"></div>
            <span><strong>CRITICAL</strong> (80-100)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e67e22;"></div>
            <span><strong>HIGH</strong> (60-79)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f39c12;"></div>
            <span><strong>MEDIUM</strong> (40-59)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #27ae60;"></div>
            <span><strong>LOW</strong> (0-39)</span>
        </div>
    </div>

    <!-- Search Form -->
    <form method="get" class="search-form" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
        <input type="hidden" name="filter" value="{{ venue_filter }}">
        <div style="display: flex; align-items: center; gap: 5px;">
            <label for="keyword" style="margin: 0;">{% trans "Search" %}:</label>
            <input type="text" id="keyword" name="keyword" value="{{ keyword }}" placeholder="{% trans 'Event name or venue' %}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <label for="start_date" style="margin: 0;">{% trans "Start Date" %}:</label>
            <input type="date" id="start_date" name="start_date" value="{{ start_date }}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <label for="end_date" style="margin: 0;">{% trans "End Date" %}:</label>
            <input type="date" id="end_date" name="end_date" value="{{ end_date }}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <button type="submit" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">{% trans "Search" %}</button>
    </form>

    <!-- List/Calendar View Toggle -->
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 10px; margin-bottom: 20px;">
        <a href="?view=list&filter={{ venue_filter }}&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}"
           class="view-toggle-btn {% if view_mode == 'list' or not view_mode %}active{% endif %}"
           style="margin-left: 0;">
            üìã List View
        </a>
        <a href="?view=calendar&filter={{ venue_filter }}&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}"
           class="view-toggle-btn {% if view_mode == 'calendar' %}active{% endif %}"
           style="margin-left: 0;">
            üìÖ Calendar View
        </a>
    </div>

    {% if view_mode == 'calendar' %}
        <!-- Calendar View -->
        <div id='calendar' data-events='{{ calendar_events|safe }}'></div>
    {% else %}
    <!-- Event List -->
    <div class="suggestion-list">
            {% if suggestions %}
                {% for suggestion in suggestions %}
                    <div class="suggestion-item color-{{ suggestion.color }}">
                        <h3>
                            <a href="{% url 'event_detail' suggestion.id %}" class="event-link">
                                {{ suggestion.name }}
                            </a>
                            <span class="popularity-badge {{ suggestion.color }}">
                                {{ suggestion.popularity_score }}
                            </span>
                            {% if suggestion.is_sold_out %}
                                <span class="sold-out-badge">SOLD OUT</span>
                            {% endif %}
                        </h3>
                        <p>{% trans "Date: " %}{{ suggestion.date|date:"l, F j, Y" }}</p>
                        <p>{% trans "Venue: " %}{{ suggestion.venue }}</p>
                        <p>{% trans "Ticket Price: " %}{{ suggestion.ticket_price }}</p>
                        <p>{% trans "Suggested Room Price: " %}<strong>{{ suggestion.suggested_price }}</strong></p>
                        {% if suggestion.image %}
                            <img src="{{ suggestion.image }}" alt="{% trans 'Event Image' %}" style="max-width: 200px; border-radius: 8px; margin-top: 10px;">
                        {% endif %}
                        <div style="margin-top: 15px;">
                            <a href="{% url 'event_detail' suggestion.id %}" class="view-details-btn">
                                üìã View Full Details
                            </a>
                        </div>
                    </div>
                {% endfor %}
        {% else %}
            {% if show_sold_out %}
                <p>{% trans "No sold-out events found for the given criteria." %}</p>
            {% else %}
                <p>{% trans "No events found. The Celery task will populate events automatically." %}</p>
            {% endif %}
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
        <div class="pagination">
            {% if current_page > 1 %}
                <a href="?filter={{ venue_filter }}&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}&show_sold_out={{ show_sold_out }}&page={{ current_page|add:'-1' }}">{% trans "Previous" %}</a>
            {% endif %}

            {% for page_num in page_range %}
                {% if page_num == current_page %}
                    <span class="current">{{ page_num }}</span>
                {% else %}
                    <a href="?filter={{ venue_filter }}&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}&show_sold_out={{ show_sold_out }}&page={{ page_num }}">{{ page_num }}</a>
                {% endif %}
            {% endfor %}

            {% if current_page < total_pages %}
                <a href="?filter={{ venue_filter }}&start_date={{ start_date }}&end_date={{ end_date }}&keyword={{ keyword }}&show_sold_out={{ show_sold_out }}&page={{ current_page|add:'1' }}">{% trans "Next" %}</a>
            {% endif %}
        </div>
    {% endif %}
    {% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% if view_mode == 'calendar' %}
<script src="{% static 'lib/fullcalendar/fullcalendar.min.js' %}"></script>
<script src="{% static 'js/price_suggester_calendar.js' %}"></script>
{% endif %}
{% endblock %}

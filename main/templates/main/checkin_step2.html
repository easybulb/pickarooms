{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Check-In - Your Details" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkin.css' %}">
{% endblock %}

{% block content %}
<section class="checkin-hero">
    <div class="checkin-content">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step completed">
                <span class="step-number">1</span>
                <span class="checkmark">✓</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step active">
                <span class="step-number">2</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">3</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <span class="step-number">4</span>
            </div>
        </div>

        <h1>{% trans "Your Details" %}</h1>
        <p>{% trans "Please provide your contact information to complete check-in." %}</p>

        <!-- GDPR Privacy Notice -->
        <div class="privacy-notice">
            <p>🔒 {% trans "We use your contact details to provide your access code and manage your stay. Your details are stored securely and can be deleted at any time by contacting us." %}</p>
        </div>

        <div class="input-area">
            {% if messages %}
                {% for message in messages %}
                    <div class="info-box" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444; margin-bottom: 20px;">
                        <p style="color: #dc2626; margin: 0; font-weight: 600;">{{ message }}</p>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" class="checkin-form" id="details-form">
                {% csrf_token %}

                <!-- Full Name -->
                <div class="form-group">
                    <label for="full_name">{% trans "Full Name" %} *</label>
                    <input type="text"
                           name="full_name"
                           id="full_name"
                           placeholder="{% trans 'John Smith' %}"
                           value="{{ flow_data.full_name|default:'' }}"
                           required
                           autofocus>
                </div>

                <!-- Phone Number with Country Code -->
                <div class="form-group">
                    <label for="phone_number">{% trans "Phone Number" %} *</label>
                    <div style="display: flex; gap: 10px; width: 100%;">
                        <select name="country_code" id="country-code" class="country-select">
                            <option value="+44" selected>🇬🇧 UK (+44)</option>
                            <option value="+1">🇺🇸 US/CA (+1)</option>
                            <option value="+91">🇮🇳 India (+91)</option>
                            <option value="+234">🇳🇬 Nigeria (+234)</option>
                            <option value="+86">🇨🇳 China (+86)</option>
                            <option value="+33">🇫🇷 France (+33)</option>
                            <option value="+49">🇩🇪 Germany (+49)</option>
                            <option value="+81">🇯🇵 Japan (+81)</option>
                            <option value="+61">🇦🇺 Australia (+61)</option>
                            <option value="+55">🇧🇷 Brazil (+55)</option>
                        </select>
                        <input type="tel"
                               name="phone_number"
                               id="phone_number"
                               placeholder="{% trans '7123456789' %}"
                               value="{{ flow_data.phone_number|default:'' }}"
                               style="flex: 1;"
                               required>
                    </div>
                    <small>{% trans "Enter without leading 0. Example: 07123456789 becomes 7123456789" %}</small>
                </div>

                <!-- Email (Optional) -->
                <div class="form-group">
                    <label for="email">{% trans "Email Address" %} <span style="font-weight: 400; color: rgba(255,255,255,0.7);">({% trans "optional" %})</span></label>
                    <input type="email"
                           name="email"
                           id="email"
                           placeholder="{% trans 'john@example.com' %}"
                           value="{{ flow_data.email|default:'' }}">
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary">
                    {% trans "Continue" %} →
                </button>
            </form>
        </div>

        <!-- Back Link -->
        <p style="text-align: center; margin-top: 15px;">
            <a href="{% url 'checkin' %}" class="back-link">← {% trans "Back to Step 1" %}</a>
        </p>

        <!-- Privacy Policy Link -->
        <p style="font-size: 13px; color: #cbd5e1; margin-top: 20px; text-align: center;">
            <a href="{% url 'privacy_policy' %}" target="_blank" style="color: #e2e8f0; text-decoration: none; font-weight: 600;">
                📜 {% trans "Read our Privacy Policy" %}
            </a>
        </p>
    </div>
</section>

<style>
    .country-select {
        width: 180px !important;
        flex-shrink: 0;
    }

    @media (max-width: 480px) {
        .country-select {
            width: 140px !important;
            font-size: 14px !important;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Phone Number Auto-Remove Leading 0
        const phoneInput = document.getElementById('phone_number');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, ''); // Remove spaces
                if (value.startsWith('0')) {
                    e.target.value = value.substring(1); // Remove leading 0
                }
            });
        }

        // Form validation feedback
        const nameInput = document.getElementById('full_name');
        const emailInput = document.getElementById('email');

        // Real-time validation
        nameInput.addEventListener('blur', function() {
            if (this.value.trim().length < 2) {
                this.style.borderColor = '#ef4444';
                this.style.background = 'rgba(239, 68, 68, 0.05)';
            } else {
                this.style.borderColor = '#10b981';
                this.style.background = 'rgba(16, 185, 129, 0.05)';
            }
        });

        phoneInput.addEventListener('blur', function() {
            if (this.value.trim().length < 7) {
                this.style.borderColor = '#ef4444';
                this.style.background = 'rgba(239, 68, 68, 0.05)';
            } else {
                this.style.borderColor = '#10b981';
                this.style.background = 'rgba(16, 185, 129, 0.05)';
            }
        });

        // Reset on focus
        [nameInput, phoneInput, emailInput].forEach(input => {
            if (input) {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#0066cc';
                    this.style.background = '#ffffff';
                });
            }
        });
    });
</script>
{% endblock %}
{% extends 'base.html' %}

{% load static %}
{% load i18n %}  {# Load translation support #}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/explore_manchester.css' %}">
{% endblock %}

{% block title %}{% trans "Explore Manchester" %}{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-overlay"></div>
    <div class="hero-text">
        <h1>{% trans "Discover the Best of Manchester" %}</h1>
        <p>{% trans "Uncover the city's top attractions, dining spots, and cultural landmarks." %}</p>
    </div>
</section>

<section class="content">
    <h2>{% trans "Top Attractions" %}</h2>
    <div class="attractions">
        <div class="attraction" data-lat="53.4778" data-lng="-2.2458">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897302/John-Rylands-Library-x_bmtgww.png"
                alt="{% trans 'John Rylands Library' %}" loading="lazy">
            <h3>{% trans "John Rylands Library" %}</h3>
            <p>{% trans "A neo-Gothic masterpiece housing rare books and manuscripts. A must-visit for history and architecture enthusiasts." %}</p>
            <button class="get-directions-btn" data-lat="53.4778" data-lng="-2.2458">{% trans "Get Directions" %}</button>
        </div>
        <div class="attraction" data-lat="53.4830" data-lng="-2.2000">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897302/Manchester-City-x_zyjtzs.png"
                alt="{% trans 'Etihad Stadium' %}" loading="lazy">
            <h3>{% trans "Etihad Stadium" %}</h3>
            <p>{% trans "Home to Manchester City FC. Take a stadium tour to explore behind the scenes of this iconic sports venue." %}</p>
            <button class="get-directions-btn" data-lat="53.4830" data-lng="-2.2000">{% trans "Get Directions" %}</button>
        </div>
        <div class="attraction" data-lat="53.4791" data-lng="-2.2500">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/science-museum-x_uqxrs4.png"
                alt="{% trans 'Science and Industry Museum' %}" loading="lazy">
            <h3>{% trans "Science and Industry Museum" %}</h3>
            <p>{% trans "Delve into Manchester\'s industrial past with interactive exhibits and historical artifacts." %}</p>
            <button class="get-directions-btn" data-lat="53.4791" data-lng="-2.2500">{% trans "Get Directions" %}</button>
        </div>
        <div class="attraction" data-lat="53.4659" data-lng="-2.2337">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/science-museum-x_uqxrs4.png"
                alt="{% trans 'Manchester Museum' %}" loading="lazy">
            <h3>{% trans "Manchester Museum" %}</h3>
            <p>{% trans "Home to one of the UK’s most extensive collections of natural history, archaeology, and anthropology, the Manchester Museum offers a fascinating journey through time." %}</p>
            <button class="get-directions-btn" data-lat="53.4659" data-lng="-2.2337">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Culinary Delights" %}</h2>
    <div class="culinary">
        <div class="culinary-spot" data-lat="53.4790" data-lng="-2.2440">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/Vermilion-x_ibfift.png"
                alt="{% trans 'Vermilion' %}" loading="lazy">
            <h3>{% trans "Vermilion" %}</h3>
            <p>{% trans "An opulent dining destination offering a fusion of Asian and world cuisines, known for its striking decor, exotic cocktails, and immersive fine dining experience." %}</p>
            <button class="get-directions-btn" data-lat="53.4790" data-lng="-2.2440">{% trans "Get Directions" %}</button>
        </div>
        <div class="culinary-spot" data-lat="53.4570" data-lng="-2.2190">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/nothern-quarter-x_t0ndor.png"
                alt="{% trans 'Curry Mile' %}" loading="lazy">
            <h3>{% trans "Curry Mile" %}</h3>
            <p>{% trans "Experience a mile-long stretch of South Asian restaurants offering a variety of flavorful dishes." %}</p>
            <button class="get-directions-btn" data-lat="53.4570" data-lng="-2.2190">{% trans "Get Directions" %}</button>
        </div>
        <div class="culinary-spot" data-lat="53.4830" data-lng="-2.2370">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897302/Mackie-Mayor-x_snqqpc.png"
                alt="{% trans 'Mackie Mayor' %}" loading="lazy">
            <h3>{% trans "Mackie Mayor" %}</h3>
            <p>{% trans "A bustling food hall housed in a restored Victorian market, featuring diverse food vendors." %}</p>
            <button class="get-directions-btn" data-lat="53.4830" data-lng="-2.2370">{% trans "Get Directions" %}</button>
        </div>
        <div class="culinary-spot" data-lat="53.4835" data-lng="-2.2375">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897302/63-Degrees-x_v6wf10.png"
                alt="{% trans '63 Degrees' %}" loading="lazy">
            <h3>{% trans "63 Degrees" %}</h3>
            <p>{% trans "A chic French restaurant offering exquisite Parisian-inspired dishes, fine wines, and a cozy yet elegant atmosphere in the heart of Manchester’s Northern Quarter." %}</p>
            <button class="get-directions-btn" data-lat="53.4835" data-lng="-2.2375">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Shopping Destinations" %}</h2>
    <div class="shopping">
        <div class="shopping-spot" data-lat="53.4835" data-lng="-2.2430">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897302/manchester-arndale-x_cnhvc5.png"
                alt="{% trans 'Manchester Arndale' %}" loading="lazy">
            <h3>{% trans "Manchester Arndale" %}</h3>
            <p>{% trans "One of the UK\'s largest shopping centers, offering a wide range of retail stores and eateries." %}</p>
            <button class="get-directions-btn" data-lat="53.4835" data-lng="-2.2430">{% trans "Get Directions" %}</button>
        </div>
        <div class="shopping-spot" data-lat="53.4661" data-lng="-2.3499">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/trafford-centre-x_dgpaet.png"
                alt="{% trans 'Trafford Centre' %}" loading="lazy">
            <h3>{% trans "Trafford Centre" %}</h3>
            <p>{% trans "A grand shopping and leisure complex with unique architecture, shops, and entertainment options." %}</p>
            <button class="get-directions-btn" data-lat="53.4661" data-lng="-2.3499">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Cultural Experiences" %}</h2>
    <div class="cultural">
        <div class="cultural-spot" data-lat="53.4830" data-lng="-2.2380">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/nothern-quarter-x_t0ndor.png" alt="{% trans 'Northern Quarter' %}" loading="lazy">
            <h3>{% trans "Northern Quarter" %}</h3>
            <p>{% trans "A trendy district known for its street art, independent shops, and vibrant nightlife." %}</p>
            <button class="get-directions-btn" data-lat="53.4830" data-lng="-2.2380">{% trans "Get Directions" %}</button>
        </div>
        <div class="cultural-spot" data-lat="53.4570" data-lng="-2.2300">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1760897303/The-Whitworth-x_rceruw.png"
                alt="{% trans 'The Whitworth' %}" loading="lazy">
            <h3>{% trans "The Whitworth" %}</h3>
            <p>{% trans "An art gallery set in a park, showcasing a diverse collection of artworks in a serene setting." %}</p>
            <button class="get-directions-btn" data-lat="53.4570" data-lng="-2.2300">{% trans "Get Directions" %}</button>
        </div>
    </div>
</section>

<!-- Custom Modal for Directions -->
<div class="custom-modal" id="directionsModal" style="display: none;">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5 class="custom-modal-title">{% trans "Get Directions" %}</h5>
            <button class="custom-modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="custom-modal-body">
            <iframe id="modalMap" width="100%" height="400" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <div class="custom-modal-footer">
            <button class="custom-btn custom-btn-secondary" onclick="closeModal()">{% trans "Close" %}</button>
            <a href="#" id="externalDirections" class="custom-btn custom-btn-primary" target="_blank">{% trans "Open in Google Maps" %}</a>
        </div>
    </div>
</div>

<script>
    // Get Directions Button Functionality
    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded, attaching event listeners...");
        const directionButtons = document.querySelectorAll(".get-directions-btn");
        if (directionButtons.length === 0) {
            console.error("No Get Directions buttons found!");
            return;
        }

        directionButtons.forEach(button => {
            console.log("Attaching click listener to button:", button);
            button.addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default button behavior
                console.log("Button clicked, retrieving lat/lng...");
                const lat = this.getAttribute("data-lat");
                const lng = this.getAttribute("data-lng");
                if (lat && lng) {
                    console.log(`Opening modal for lat: ${lat}, lng: ${lng}`);
                    openModal(lat, lng);
                } else {
                    console.error("Latitude or longitude not found on button:", this);
                }
            });
        });
    });

    // Custom Modal Functions
    function openModal(lat, lng) {
        console.log("openModal called with lat:", lat, "lng:", lng);
        const modal = document.getElementById("directionsModal");
        if (!modal) {
            console.error("Modal element not found!");
            return;
        }

        const userLocation = new Promise((resolve, reject) => {
            console.log("Attempting to get user location...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Geolocation success:", position.coords);
                        resolve(`${position.coords.latitude},${position.coords.longitude}`);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        resolve("53.480759,-2.244644"); // Fallback to Manchester
                    }
                );
            } else {
                console.log("Geolocation not supported, using fallback...");
                resolve("53.480759,-2.244644"); // Fallback for no geolocation
            }
        });

        userLocation.then(location => {
            console.log("User location resolved:", location);
            const apiKey = "{{ GOOGLE_MAPS_API_KEY }}"; // Use Django template variable
            console.log("API Key:", apiKey); // Log the API key to verify it’s rendered correctly
            if (!apiKey || apiKey.trim() === "") {
                console.error("API Key is empty or not set in template!");
                alert("API Key is missing. Please configure GOOGLE_MAPS_API_KEY in Django settings.");
                return;
            }
            const url = `https://www.google.com/maps/embed/v1/directions?key=${apiKey}&origin=${location}&destination=${lat},${lng}&mode=driving`;
            console.log("Loading directions with URL:", url); // Log the URL for debugging
            const modalMap = document.getElementById("modalMap");
            const externalDirections = document.getElementById("externalDirections");

            if (modalMap && externalDirections) {
                console.log("Setting iframe src and link href...");
                modalMap.src = url;
                externalDirections.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                modal.style.display = "block";
            } else {
                console.error("Modal map or external directions element not found!");
            }
        }).catch(error => {
            console.error('Error loading directions:', error);
            const modalMap = document.getElementById("modalMap");
            if (modalMap) {
                console.log("Setting error message in iframe...");
                modalMap.src = '';
                modalMap.innerHTML = '<p>Directions failed to load. Please check your internet connection, API key, or ensure the Maps Embed API is enabled.</p>';
                modal.style.display = "block";
            }
        });
    }

    function closeModal() {
        console.log("closeModal called...");
        const modal = document.getElementById("directionsModal");
        const modalMap = document.getElementById("modalMap");
        if (modal) {
            modal.style.display = "none";
        }
        if (modalMap) {
            modalMap.src = ''; // Clear the iframe to prevent loading when closed
            console.log("Iframe cleared...");
        }
    }
</script>
{% endblock %}
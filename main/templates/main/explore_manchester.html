{% extends 'base.html' %}

{% load static %}
{% load i18n %}  {# Load translation support #}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/explore_manchester.css' %}">
{% endblock %}

{% block title %}{% trans "Explore Manchester" %}{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-overlay"></div>
    <div class="hero-text">
        <h1>{% trans "Discover the Best of Manchester" %}</h1>
        <p>{% trans "Uncover the city's top attractions, dining spots, and cultural landmarks." %}</p>
    </div>
</section>

<section class="content">
    <h2>{% trans "Top Attractions" %}</h2>
    <div class="attractions">
        <div class="attraction" data-lat="53.4778" data-lng="-2.2458">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738679218/John_Rylands_Library_Reading_Room_hr3v6g.jpg"
                alt="{% trans 'John Rylands Library' %}" loading="lazy">
            <h3>{% trans "John Rylands Library" %}</h3>
            <p>{% trans "A neo-Gothic masterpiece housing rare books and manuscripts. A must-visit for history and architecture enthusiasts." %}</p>
            <button class="get-directions-btn" data-lat="53.4778" data-lng="-2.2458">{% trans "Get Directions" %}</button>
        </div>
        <div class="attraction" data-lat="53.4830" data-lng="-2.2000">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738678963/manchester13_mtl3ev.webp"
                alt="{% trans 'Etihad Stadium' %}" loading="lazy">
            <h3>{% trans "Etihad Stadium" %}</h3>
            <p>{% trans "Home to Manchester City FC. Take a stadium tour to explore behind the scenes of this iconic sports venue." %}</p>
            <button class="get-directions-btn" data-lat="53.4830" data-lng="-2.2000">{% trans "Get Directions" %}</button>
        </div>
        <div class="attraction" data-lat="53.4791" data-lng="-2.2500">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738678963/manchester7_h7ntsy.jpg"
                alt="{% trans 'Science and Industry Museum' %}" loading="lazy">
            <h3>{% trans "Science and Industry Museum" %}</h3>
            <p>{% trans "Delve into Manchester\'s industrial past with interactive exhibits and historical artifacts." %}</p>
            <button class="get-directions-btn" data-lat="53.4791" data-lng="-2.2500">{% trans "Get Directions" %}</button>
        </div>
        <div class="attraction" data-lat="53.4659" data-lng="-2.2337">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738678962/manchester11_gyrvwm.jpg"
                alt="{% trans 'Manchester Museum' %}" loading="lazy">
            <h3>{% trans "Manchester Museum" %}</h3>
            <p>{% trans "Home to one of the UK’s most extensive collections of natural history, archaeology, and anthropology, the Manchester Museum offers a fascinating journey through time." %}</p>
            <button class="get-directions-btn" data-lat="53.4659" data-lng="-2.2337">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Culinary Delights" %}</h2>
    <div class="culinary">
        <div class="culinary-spot" data-lat="53.4790" data-lng="-2.2440">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738679945/vermilion_1_lny7st.jpg"
                alt="{% trans 'Vermilion' %}" loading="lazy">
            <h3>{% trans "Vermilion" %}</h3>
            <p>{% trans "An opulent dining destination offering a fusion of Asian and world cuisines, known for its striking decor, exotic cocktails, and immersive fine dining experience." %}</p>
            <button class="get-directions-btn" data-lat="53.4790" data-lng="-2.2440">{% trans "Get Directions" %}</button>
        </div>
        <div class="culinary-spot" data-lat="53.4570" data-lng="-2.2190">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738679450/Curry-Mile_bmfnu9.webp"
                alt="{% trans 'Curry Mile' %}" loading="lazy">
            <h3>{% trans "Curry Mile" %}</h3>
            <p>{% trans "Experience a mile-long stretch of South Asian restaurants offering a variety of flavorful dishes." %}</p>
            <button class="get-directions-btn" data-lat="53.4570" data-lng="-2.2190">{% trans "Get Directions" %}</button>
        </div>
        <div class="culinary-spot" data-lat="53.4830" data-lng="-2.2370">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738679565/mackie-mayor_1_eqdfw7.jpg"
                alt="{% trans 'Mackie Mayor' %}" loading="lazy">
            <h3>{% trans "Mackie Mayor" %}</h3>
            <p>{% trans "A bustling food hall housed in a restored Victorian market, featuring diverse food vendors." %}</p>
            <button class="get-directions-btn" data-lat="53.4830" data-lng="-2.2370">{% trans "Get Directions" %}</button>
        </div>
        <div class="culinary-spot" data-lat="53.4835" data-lng="-2.2375">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738680065/63-degrees_w5xxwv.jpg"
                alt="{% trans '63 Degrees' %}" loading="lazy">
            <h3>{% trans "63 Degrees" %}</h3>
            <p>{% trans "A chic French restaurant offering exquisite Parisian-inspired dishes, fine wines, and a cozy yet elegant atmosphere in the heart of Manchester’s Northern Quarter." %}</p>
            <button class="get-directions-btn" data-lat="53.4835" data-lng="-2.2375">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Shopping Destinations" %}</h2>
    <div class="shopping">
        <div class="shopping-spot" data-lat="53.4835" data-lng="-2.2430">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738678964/manchester3_dqqx1n.jpg"
                alt="{% trans 'Manchester Arndale' %}" loading="lazy">
            <h3>{% trans "Manchester Arndale" %}</h3>
            <p>{% trans "One of the UK\'s largest shopping centers, offering a wide range of retail stores and eateries." %}</p>
            <button class="get-directions-btn" data-lat="53.4835" data-lng="-2.2430">{% trans "Get Directions" %}</button>
        </div>
        <div class="shopping-spot" data-lat="53.4661" data-lng="-2.3499">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738678963/manchester9_npnzld.jpg"
                alt="{% trans 'Trafford Centre' %}" loading="lazy">
            <h3>{% trans "Trafford Centre" %}</h3>
            <p>{% trans "A grand shopping and leisure complex with unique architecture, shops, and entertainment options." %}</p>
            <button class="get-directions-btn" data-lat="53.4661" data-lng="-2.3499">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Cultural Experiences" %}</h2>
    <div class="cultural">
        <div class="cultural-spot" data-lat="53.4830" data-lng="-2.2380">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738681996/The-Northern-Quarter_1_worr1l.png" alt="{% trans 'Northern Quarter' %}" loading="lazy">
            <h3>{% trans "Northern Quarter" %}</h3>
            <p>{% trans "A trendy district known for its street art, independent shops, and vibrant nightlife." %}</p>
            <button class="get-directions-btn" data-lat="53.4830" data-lng="-2.2380">{% trans "Get Directions" %}</button>
        </div>
        <div class="cultural-spot" data-lat="53.4570" data-lng="-2.2300">
            <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1738678964/manchester1_tnxsj8.jpg"
                alt="{% trans 'The Whitworth' %}" loading="lazy">
            <h3>{% trans "The Whitworth" %}</h3>
            <p>{% trans "An art gallery set in a park, showcasing a diverse collection of artworks in a serene setting." %}</p>
            <button class="get-directions-btn" data-lat="53.4570" data-lng="-2.2300">{% trans "Get Directions" %}</button>
        </div>
    </div>

    <h2>{% trans "Map of Manchester" %}</h2>
    <div class="map">
        <div id="map" style="width: 100%; max-width: 800px; height: 450px;"></div>
    </div>

<!-- Custom Modal for Directions -->
<div class="custom-modal" id="directionsModal" style="display: none;">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5 class="custom-modal-title">{% trans "Get Directions" %}</h5>
            <button class="custom-modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="custom-modal-body">
            <iframe id="modalMap" width="100%" height="400" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <div class="custom-modal-footer">
            <button class="custom-btn custom-btn-secondary" onclick="closeModal()">{% trans "Close" %}</button>
            <a href="#" id="externalDirections" class="custom-btn custom-btn-primary" target="_blank">{% trans "Open in Google Maps" %}</a>
        </div>
    </div>
</div>

<script>
    // Initialize Google Map with Markers
    function initMap() {
        try {
            console.log("Initializing Google Map...");
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 53.480759, lng: -2.244644 },
                zoom: 12,
            });

            const locations = [
                {
                    title: "{% trans 'John Rylands Library' %}",
                    lat: 53.4778,
                    lng: -2.2458,
                    type: "attraction",
                    description: "{% trans 'A neo-Gothic masterpiece housing rare books and manuscripts. A must-visit for history and architecture enthusiasts.' %}"
                },
                {
                    title: "{% trans 'Etihad Stadium' %}",
                    lat: 53.4830,
                    lng: -2.2000,
                    type: "attraction",
                    description: "{% trans 'Home to Manchester City FC. Take a stadium tour to explore behind the scenes of this iconic sports venue.' %}"
                },
                {
                    title: "{% trans 'Science and Industry Museum' %}",
                    lat: 53.4791,
                    lng: -2.2500,
                    type: "attraction",
                    description: "{% trans 'Delve into Manchester\'s industrial past with interactive exhibits and historical artifacts.' %}"
                },
                {
                    title: "{% trans 'Manchester Museum' %}",
                    lat: 53.4659,
                    lng: -2.2337,
                    type: "attraction",
                    description: "{% trans 'Home to one of the UK’s most extensive collections of natural history, archaeology, and anthropology, the Manchester Museum offers a fascinating journey through time.' %}"
                },
                {
                    title: "{% trans 'Vermilion' %}",
                    lat: 53.4790,
                    lng: -2.2440,
                    type: "culinary",
                    description: "{% trans 'An opulent dining destination offering a fusion of Asian and world cuisines, known for its striking decor, exotic cocktails, and immersive fine dining experience.' %}"
                },
                {
                    title: "{% trans 'Curry Mile' %}",
                    lat: 53.4570,
                    lng: -2.2190,
                    type: "culinary",
                    description: "{% trans 'Experience a mile-long stretch of South Asian restaurants offering a variety of flavorful dishes.' %}"
                },
                {
                    title: "{% trans 'Mackie Mayor' %}",
                    lat: 53.4830,
                    lng: -2.2370,
                    type: "culinary",
                    description: "{% trans 'A bustling food hall housed in a restored Victorian market, featuring diverse food vendors.' %}"
                },
                {
                    title: "{% trans '63 Degrees' %}",
                    lat: 53.4835,
                    lng: -2.2375,
                    type: "culinary",
                    description: "{% trans 'A chic French restaurant offering exquisite Parisian-inspired dishes, fine wines, and a cozy yet elegant atmosphere in the heart of Manchester’s Northern Quarter.' %}"
                },
                {
                    title: "{% trans 'Manchester Arndale' %}",
                    lat: 53.4835,
                    lng: -2.2430,
                    type: "shopping",
                    description: "{% trans 'One of the UK\'s largest shopping centers, offering a wide range of retail stores and eateries.' %}"
                },
                {
                    title: "{% trans 'Trafford Centre' %}",
                    lat: 53.4661,
                    lng: -2.3499,
                    type: "shopping",
                    description: "{% trans 'A grand shopping and leisure complex with unique architecture, shops, and entertainment options.' %}"
                },
                {
                    title: "{% trans 'Northern Quarter' %}",
                    lat: 53.4830,
                    lng: -2.2380,
                    type: "cultural",
                    description: "{% trans 'A trendy district known for its street art, independent shops, and vibrant nightlife.' %}"
                },
                {
                    title: "{% trans 'The Whitworth' %}",
                    lat: 53.4570,
                    lng: -2.2300,
                    type: "cultural",
                    description: "{% trans 'An art gallery set in a park, showcasing a diverse collection of artworks in a serene setting.' %}"
                },
            ];

            locations.forEach(location => {
                console.log(`Adding marker for ${location.title} at ${location.lat}, ${location.lng}`);
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.title,
                });

                const infowindow = new google.maps.InfoWindow({
                    content: `
                      <h3>${location.title}</h3>
                      <p>${location.description}</p>
                      <p>Type: ${location.type}</p>
                      <button class="get-directions-btn" data-lat="${location.lat}" data-lng="${location.lng}">{% trans "Get Directions" %}</button>
                    `,
                });

                marker.addListener("click", () => {
                    console.log(`Marker clicked for ${location.title}`);
                    infowindow.open(map, marker);
                });
            });
        } catch (error) {
            console.error('Error initializing Google Map:', error);
            document.getElementById("map").innerHTML = '<p>Map failed to load. Please check your internet connection, API key, or ensure the Maps JavaScript API is enabled.</p>';
        }
    }

    // Get Directions Button Functionality
    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded, attaching event listeners...");
        const directionButtons = document.querySelectorAll(".get-directions-btn");
        if (directionButtons.length === 0) {
            console.error("No Get Directions buttons found!");
            return;
        }

        directionButtons.forEach(button => {
            console.log("Attaching click listener to button:", button);
            button.addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default button behavior
                console.log("Button clicked, retrieving lat/lng...");
                const lat = this.getAttribute("data-lat");
                const lng = this.getAttribute("data-lng");
                if (lat && lng) {
                    console.log(`Opening modal for lat: ${lat}, lng: ${lng}`);
                    openModal(lat, lng);
                } else {
                    console.error("Latitude or longitude not found on button:", this);
                }
            });
        });
    });

    // Ensure Google Maps API loads before initMap
    window.initMap = initMap;
</script>

<!-- Separate Script for Custom Modal Functions -->
<script>
    // Custom Modal Functions
    function openModal(lat, lng) {
    console.log("openModal called with lat:", lat, "lng:", lng);
    const modal = document.getElementById("directionsModal");
    if (!modal) {
        console.error("Modal element not found!");
        return;
    }

    const userLocation = new Promise((resolve, reject) => {
        console.log("Attempting to get user location...");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log("Geolocation success:", position.coords);
                    resolve(`${position.coords.latitude},${position.coords.longitude}`);
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    resolve("53.480759,-2.244644"); // Fallback to Manchester
                }
            );
        } else {
            console.log("Geolocation not supported, using fallback...");
            resolve("53.480759,-2.244644"); // Fallback for no geolocation
        }
    });

    userLocation.then(location => {
        console.log("User location resolved:", location);
        const apiKey = "{{ GOOGLE_MAPS_API_KEY }}"; // Use Django template variable
        console.log("API Key:", apiKey); // Log the API key to verify it’s rendered correctly
        if (!apiKey || apiKey.trim() === "") {
            console.error("API Key is empty or not set in template!");
            alert("API Key is missing. Please configure GOOGLE_MAPS_API_KEY in Django settings.");
            return;
        }
        const url = `https://www.google.com/maps/embed/v1/directions?key=${apiKey}&origin=${location}&destination=${lat},${lng}&mode=driving`;
        console.log("Loading directions with URL:", url); // Log the URL for debugging
        const modalMap = document.getElementById("modalMap");
        const externalDirections = document.getElementById("externalDirections");

        if (modalMap && externalDirections) {
            console.log("Setting iframe src and link href...");
            modalMap.src = url;
            externalDirections.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            modal.style.display = "block";
        } else {
            console.error("Modal map or external directions element not found!");
        }
    }).catch(error => {
        console.error('Error loading directions:', error);
        const modalMap = document.getElementById("modalMap");
        if (modalMap) {
            console.log("Setting error message in iframe...");
            modalMap.src = '';
            modalMap.innerHTML = '<p>Directions failed to load. Please check your internet connection, API key, or ensure the Maps Embed API is enabled.</p>';
            modal.style.display = "block";
        }
    });
}

    function closeModal() {
        console.log("closeModal called...");
        const modal = document.getElementById("directionsModal");
        const modalMap = document.getElementById("modalMap");
        if (modal) {
            modal.style.display = "none";
        }
        if (modalMap) {
            modalMap.src = ''; // Clear the iframe to prevent loading when closed
            console.log("Iframe cleared...");
        }
    }
</script>

<!-- Google Maps API Script -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
{% endblock %}
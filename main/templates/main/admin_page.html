{% extends 'base.html' %}

{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_page.css' %}">
<style>
    .nav-link {
        margin-bottom: 10px;
    }
    .nav-link {
        display: inline-block;
        margin-right: 20px;
        color: #007bff;
        text-decoration: none;
        font-size: 16px;
    }
    .nav-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block title %}{% trans "Admin Dashboard" %}{% endblock %}

{% block content %}
<section class="admin-container">
    <div class="nav-link">
        <a href="{% url 'admin_page' %}" class="nav-link">{% trans "Dashboard" %}</a>
        <a href="{% url 'all_reservations' %}" class="nav-link">{% trans "All Reservations" %}</a>
        <a href="{% url 'pending_enrichments_page' %}" class="nav-link">{% trans "Pending Enrichments" %}</a>
        <a href="{% url 'enrichment_logs_page' %}" class="nav-link">{% trans "Enrichment Logs" %}</a>
        <a href="{% url 'xls_upload_page' %}" class="nav-link">{% trans "XLS Upload" %}</a>
        <a href="{% url 'message_templates' %}" class="nav-link">{% trans "Message Templates" %}</a>
        {% if 'main.can_give_access' in perms %}
            <a href="{% url 'give_access' %}" class="nav-link">{% trans "Open Doors" %}</a>
        {% endif %}
        {% if 'main.manage_rooms' in perms %}
        <a href="{% url 'room_management' %}" class="nav-link">{% trans "Manage Rooms" %}</a>
        {% endif %}
        {% if user.is_superuser %}
            <a href="{% url 'user_management' %}" class="nav-link">{% trans "Manage Admins" %}</a>
            <a href="{% url 'price_suggester' %}" class="nav-link">{% trans "Price Suggester" %}</a>
            <a href="{% url 'audit_logs' %}" class="nav-link">{% trans "Audit Logs" %}</a>
            <a href="{% url 'block_review_messages' %}" class="nav-link">{% trans "Block Review Messages" %}</a>
        {% endif %}
    </div>
    <h1 class="admin-title">{% trans "Admin Dashboard" %}</h1>

    {% if messages %}
        {% for message in messages %}
            <p class="{% if message.tags == 'success' %}success-message{% else %}error-message{% endif %}" id="message-{{ forloop.counter }}">
                {{ message }}
            </p>
        {% endfor %}
        <input type="hidden" id="guest-added" value="{% if messages %}true{% else %}false{% endif %}">
    {% endif %}

    <!-- Today's Guests -->
    <div class="admin-section">
        <div class="existing-guests-header">
            <h2>{% trans "Today's Guests" %}</h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="location.reload();" class="add-guest-btn" style="background: #28a745;">{% trans "Refresh" %}</button>
                <a href="#add-guest-form" class="add-guest-btn">{% trans "Add Guest" %}</a>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>{% trans "Full Name" %}</th>
                        <th>{% trans "Booking Ref" %}</th>
                        <th>{% trans "Platform" %}</th>
                        <th>{% trans "Room" %}</th>
                        <th>{% trans "PIN (Front Door & Room)" %}</th>
                        <th>{% trans "PIN Validity" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in todays_entries %}
                    <tr style="{% if not entry.is_enriched %}background-color: #fff8dc;{% endif %}">
                        <td>
                            {% if entry.is_enriched %}
                                {% if user.is_superuser %}
                                    <a href="{% url 'guest_details' entry.guest_id %}">{{ entry.full_name }}</a>
                                {% else %}
                                    {{ entry.full_name }}
                                {% endif %}
                                {% if entry.is_returning %}
                                    <span class="returning-guest" title="Returning Guest"> (R) </span>
                                {% endif %}
                                <br>
                                <small>{% trans "Tel:" %} {{ entry.phone_number|default:"Not provided" }}</small>
                                <br>
                                <small>{% trans "Email:" %} {{ entry.email|default:"Not provided" }}</small>
                            {% else %}
                                <strong style="color: #ff8c00;">{% trans "(Pending Check-In)" %}</strong>
                                <br>
                                <small>{% trans "Guest needs to check in via app or manual check-in below" %}</small>
                            {% endif %}
                        </td>
                        <td>{{ entry.booking_ref }}</td>
                        <td>{{ entry.platform|safe }}</td>
                        <td>{{ entry.room.name }}</td>
                        <td class="pin-code">
                            {% if entry.pin %}
                                {{ entry.pin }}
                            {% else %}
                                <span class="no-pin">{% trans "N/A" %}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.pin %}
                                {{ entry.check_in_date }} {% if entry.early_checkin_time %}{{ entry.early_checkin_time|time:"h:i A" }}{% else %}2:00 PM{% endif %} -
                                {{ entry.check_out_date }} {% if entry.late_checkout_time %}{{ entry.late_checkout_time|time:"h:i A" }}{% else %}11:00 AM{% endif %}
                            {% else %}
                                <span class="no-pin">{% trans "N/A" %}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.is_enriched %}
                                <a href="{% url 'manage_checkin_checkout' entry.guest_id %}" class="edit-link">{% trans "Check-In/Out" %}</a> |
                                <a href="{% url 'edit_guest' entry.guest_id %}" class="edit-link">{% trans "Edit" %}</a> |
                                <a href="{% url 'delete_guest' entry.guest_id %}" class="delete-link" onclick="return confirm('Are you sure you want to delete this guest? This will also delete their PIN.');">
                                    {% trans "Delete" %}
                                </a>
                            {% else %}
                                <a href="{% url 'edit_reservation' entry.reservation_id %}" class="edit-link">{% trans "Edit" %}</a> |
                                <a href="{% url 'manual_checkin_reservation' entry.reservation_id %}" class="edit-link" style="background: #4CAF50; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px; display: inline-block;">
                                    {% trans "Manual Check-In" %}
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">{% trans "No guests checking in today." %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p>
            <a href="{% url 'past_guests' %}" class="past-guests-link">{% trans "View past guests" %}</a>
        </p>
    </div>

    <br id="add-guest-form">

    <!-- Guest Form -->
    <div class="admin-section">
        <h2>{% trans "Add New Guest" %}</h2>
        <form id="add-guest-form-element" method="POST">
            {% csrf_token %}
            <label for="full_name">{% trans "Full Name:" %}</label>
            <input type="text" id="full_name" name="full_name" required>

            <label for="reservation_number">{% trans "Reservation Number:" %}</label>
            <input type="text" id="reservation_number" name="reservation_number" required maxlength="15">
            <p class="note">{% trans "Typically 10 characters (Booking.com format). Maximum 15 characters allowed." %}</p>

            <label for="phone_number">{% trans "Phone Number (Optional):" %}</label>
            <input type="text" id="phone_number" name="phone_number">

            <label for="email">{% trans "Email (Optional):" %}</label>
            <input type="email" id="email" name="email">

            <label for="check_in_date">{% trans "Check-In Date:" %}</label>
            <input type="date" id="check_in_date" name="check_in_date" required>

            <!-- Early Check-In Time -->
            <label for="early_checkin_time">{% trans "Early Check-In Time (e.g., 12:00):" %}</label>
            <input type="time" id="early_checkin_time" name="early_checkin_time" placeholder="HH:MM">
            <p class="note">{% trans "Leave blank to use default (2:00 PM)." %}</p>

            <!-- Stay Duration -->
            <label for="stay_duration">{% trans "Stay Duration:" %}</label>
            <div class="radio-group">
                <label for="stay_duration_1"><input type="radio" id="stay_duration_1" name="stay_duration" value="1"> 1 {% trans "Night" %}</label>
                <label for="stay_duration_2"><input type="radio" id="stay_duration_2" name="stay_duration" value="2"> 2 {% trans "Nights" %}</label>
                <label for="stay_duration_3"><input type="radio" id="stay_duration_3" name="stay_duration" value="3"> 3 {% trans "Nights" %}</label>
            </div>            
        
            <label for="check_out_date">{% trans "Check-Out Date:" %}</label>
            <input type="date" id="check_out_date" name="check_out_date" placeholder="dd/mm/yyyy">

            <!-- Late Check-Out Time -->
            <label for="late_checkout_time">{% trans "Late Check-Out Time (e.g., 14:00):" %}</label>
            <input type="time" id="late_checkout_time" name="late_checkout_time" placeholder="HH:MM">
            <p class="note">{% trans "Leave blank to use default (11:00 AM)." %}</p>

            <label for="select-room">{% trans "Assign Room:" %}</label>
            <select id="select-room" name="room" required>
                <option value="">-- {% trans "Select Room" %} --</option>
                {% for room in rooms %}
                    <option value="{{ room.id }}">{{ room.name }}</option>
                {% endfor %}
            </select>
            <br>
            <button type="submit" class="admin-button">{% trans "Add Guest" %}</button>
        </form>
    </div>

    <!-- iCal Configuration Section -->
    <div class="admin-section" style="margin-top: 40px;">
        <h2>{% trans "iCal Feed Management" %}</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            {% trans "Configure automatic booking synchronization from Booking.com and Airbnb iCal feeds." %}
        </p>

        <!-- Overlapping Reservations Warning -->
        {% if overlapping_warnings %}
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; font-size: 16px; color: #856404;">⚠️ {% trans "Overlapping Reservations Detected" %}</h3>
            {% for warning in overlapping_warnings %}
            <div style="margin: 10px 0; padding: 10px; background: #fff; border-left: 3px solid #ffc107;">
                <strong>{{ warning.room }}</strong>:
                <span style="background: #003580; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">{{ warning.platform1 }}</span>
                ({{ warning.res1_guest }})
                {% trans "and" %}
                <span style="background: #FF5A5F; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">{{ warning.platform2 }}</span>
                ({{ warning.res2_guest }})
                <br>
                <small>{% trans "Overlap period:" %} {{ warning.dates }}</small>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Help Documentation -->
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; font-size: 16px;">{% trans "How to Use iCal Sync" %}</h3>
            <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                <li>{% trans "Copy the iCal feed URL from Booking.com or Airbnb calendar settings and paste it below" %}</li>
                <li>{% trans "The system automatically checks for new reservations every 10 minutes" %}</li>
                <li>{% trans "Click 'Sync Now' to immediately fetch the latest reservations from the feed" %}</li>
                <li>{% trans "New reservations appear as unenriched entries. Guests provide their details when checking in." %}</li>
                <li>{% trans "You can enable one or both platforms per room" %}</li>
            </ul>
            <p style="margin: 10px 0 0 0; font-size: 14px;">
                <strong>{% trans "Status:" %}</strong>
                <span style="color: #28a745;">✅ {% trans "Background sync active" %}</span>
            </p>
        </div>

        {% for room in rooms %}
        {% for config_room_id, config in ical_configs.items %}
        {% if config_room_id == room.id %}
        <div style="border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 8px; background: #fff;">
            <h3 style="margin-top: 0;">{{ room.name }}</h3>

            <!-- Booking.com Configuration -->
            <div style="border-left: 3px solid #003580; padding-left: 15px; margin-bottom: 20px;">
                <h4 style="color: #003580; margin-top: 0;">📘 Booking.com</h4>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="ical_action" value="save_ical">
                    <input type="hidden" name="ical_room_id" value="{{ room.id }}">
                    <input type="hidden" name="platform" value="booking">

                    <label for="booking_url_{{ room.id }}">{% trans "Booking.com iCal URL:" %}</label>
                    <input type="url"
                           id="booking_url_{{ room.id }}"
                           name="ical_url"
                           placeholder="https://admin.booking.com/hotel/.../ical/..."
                           value="{% if config %}{{ config.booking_ical_url }}{% endif %}"
                           style="width: 100%; padding: 8px; margin-bottom: 10px;">

                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox"
                                   name="is_active"
                                   {% if config and config.booking_active %}checked{% endif %}>
                            <span style="margin-left: 5px;">{% trans "Enable Booking.com sync" %}</span>
                        </label>
                    </div>

                    {% if config %}
                    <p style="font-size: 13px; color: #666; margin: 10px 0;">
                        <strong>{% trans "Status:" %}</strong>
                        {% if config.booking_active %}
                            <span style="color: #28a745;">✅ {% trans "Active" %}</span>
                        {% else %}
                            <span style="color: #dc3545;">❌ {% trans "Inactive" %}</span>
                        {% endif %}
                        <br>
                        <strong>{% trans "Last Synced:" %}</strong>
                        {% if config.booking_last_synced %}
                            {{ config.booking_last_synced|date:"Y-m-d H:i" }} (UK)
                        {% else %}
                            {% trans "Never" %}
                        {% endif %}
                        {% if config.booking_last_sync_status %}
                            <br><strong>{% trans "Last Status:" %}</strong> {{ config.booking_last_sync_status }}
                        {% endif %}
                    </p>
                    {% endif %}

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="admin-button">{% trans "Save" %}</button>
                        {% if config and config.booking_ical_url %}
                        <button type="submit"
                                formaction="{% url 'admin_page' %}"
                                onclick="this.form.ical_action.value='sync_now'; this.form.config_id.value='{{ config.id }}'; this.form.platform.value='booking';"
                                class="admin-button"
                                style="background: #17a2b8;">{% trans "Sync Now" %}</button>
                        <input type="hidden" name="config_id">
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Airbnb Configuration -->
            <div style="border-left: 3px solid #FF5A5F; padding-left: 15px;">
                <h4 style="color: #FF5A5F; margin-top: 0;">🏠 Airbnb</h4>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="ical_action" value="save_ical">
                    <input type="hidden" name="ical_room_id" value="{{ room.id }}">
                    <input type="hidden" name="platform" value="airbnb">

                    <label for="airbnb_url_{{ room.id }}">{% trans "Airbnb iCal URL:" %}</label>
                    <input type="url"
                           id="airbnb_url_{{ room.id }}"
                           name="ical_url"
                           placeholder="https://www.airbnb.com/calendar/ical/..."
                           value="{% if config %}{{ config.airbnb_ical_url }}{% endif %}"
                           style="width: 100%; padding: 8px; margin-bottom: 10px;">

                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox"
                                   name="is_active"
                                   {% if config and config.airbnb_active %}checked{% endif %}>
                            <span style="margin-left: 5px;">{% trans "Enable Airbnb sync" %}</span>
                        </label>
                    </div>

                    {% if config %}
                    <p style="font-size: 13px; color: #666; margin: 10px 0;">
                        <strong>{% trans "Status:" %}</strong>
                        {% if config.airbnb_active %}
                            <span style="color: #28a745;">✅ {% trans "Active" %}</span>
                        {% else %}
                            <span style="color: #dc3545;">❌ {% trans "Inactive" %}</span>
                        {% endif %}
                        <br>
                        <strong>{% trans "Last Synced:" %}</strong>
                        {% if config.airbnb_last_synced %}
                            {{ config.airbnb_last_synced|date:"Y-m-d H:i" }} (UK)
                        {% else %}
                            {% trans "Never" %}
                        {% endif %}
                        {% if config.airbnb_last_sync_status %}
                            <br><strong>{% trans "Last Status:" %}</strong> {{ config.airbnb_last_sync_status }}
                        {% endif %}
                    </p>
                    {% endif %}

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="admin-button">{% trans "Save" %}</button>
                        {% if config and config.airbnb_ical_url %}
                        <button type="submit"
                                formaction="{% url 'admin_page' %}"
                                onclick="this.form.ical_action.value='sync_now'; this.form.config_id.value='{{ config.id }}'; this.form.platform.value='airbnb';"
                                class="admin-button"
                                style="background: #17a2b8;">{% trans "Sync Now" %}</button>
                        <input type="hidden" name="config_id">
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endfor %}
    </div>

    <h2>{% trans "Past Guests" %}</h2>
    <p>
        <a href="{% url 'past_guests' %}" class="past-guests-link">{% trans "View past guests" %}</a>
    </p>

    <h2>{% trans "All Reservations" %}</h2>
    <p>
        <a href="{% url 'all_reservations' %}" class="past-guests-link">{% trans "View all reservations (Booking.com & Airbnb)" %}</a>
    </p>
</section>

<!-- JavaScript for Stay Duration, Available Rooms & Page Scroll -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("check_in_date").value = today;

        function updateRooms() {
            const checkInDate = document.getElementById('check_in_date').value;
            const checkOutDate = document.getElementById('check_out_date').value;

            if (checkInDate && checkOutDate) {
                fetch(`/admin-page/available-rooms/?check_in_date=${checkInDate}&check_out_date=${checkOutDate}`)
                    .then(response => response.json())
                    .then(data => {
                        const roomSelect = document.getElementById('select-room');
                        roomSelect.innerHTML = '<option value="">-- {% trans "Select Room" %} --</option>';
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.id;
                            option.textContent = room.name;
                            roomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching available rooms:', error));
            }
        }

        function updateCheckout(days) {
            if (!days) return;
            let checkIn = new Date(document.getElementById("check_in_date").value);
            checkIn.setDate(checkIn.getDate() + parseInt(days));
            document.getElementById("check_out_date").value = checkIn.toISOString().split('T')[0];
            updateRooms();
        }

        document.querySelectorAll("input[name='stay_duration']").forEach(radio => {
            radio.addEventListener("change", function () {
                updateCheckout(this.value);
            });
        });

        // Attach event listeners for date changes
        document.getElementById('check_in_date').addEventListener('change', updateRooms);
        document.getElementById('check_out_date').addEventListener('change', updateRooms);

        // Attach form validation
        document.getElementById("add-guest-form-element").addEventListener("submit", function (event) {
            const selectedRoomId = document.getElementById('select-room').value;
            const checkInDate = document.getElementById('check_in_date').value;
            const checkOutDate = document.getElementById('check_out_date').value;

            if (!selectedRoomId) {
                alert("Please select a room.");
                event.preventDefault();
                return;
            }

            if (!checkInDate || !checkOutDate) {
                alert("Please select check-in and check-out dates.");
                event.preventDefault();
                return;
            }
        });

        updateRooms();

        const guestAdded = document.getElementById("guest-added");
        if (guestAdded && guestAdded.value === "true") {
            window.scrollTo({ top: 0, behavior: "smooth" });
            setTimeout(() => {
                document.querySelectorAll("[id^='message-']").forEach(msg => {
                    msg.style.display = "none";
                });
            }, 3000);
            updateRooms();
        }

        // Handle localStorage for reassignment
        const nameField = document.getElementById("full_name");
        const phoneField = document.getElementById("phone_number");
        const emailField = document.getElementById("email");

        const storedName = localStorage.getItem("reassign_name");
        const storedPhone = localStorage.getItem("reassign_phone");
        const storedEmail = localStorage.getItem("reassign_email");

        if (storedName && storedPhone && storedEmail) {
            nameField.value = storedName;
            phoneField.value = storedPhone;
            emailField.value = storedEmail;

            localStorage.removeItem("reassign_name");
            localStorage.removeItem("reassign_phone");
            localStorage.removeItem("reassign_email");
        }
    });

    // Auto-refresh the page every 60 seconds to update Today's Guests table
    // This doesn't use Celery - just browser JavaScript timer
    setTimeout(function() {
        location.reload();
    }, 60000); // 60 seconds = 60000 milliseconds
</script>

{% endblock %}
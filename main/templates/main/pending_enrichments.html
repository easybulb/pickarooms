{% extends 'base.html' %}

{% load static %}
{% load i18n %}

{% block title %}{% trans "Pending Enrichments - Phase 5" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pending_enrichement.css' %}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Navigation -->
    <div class="nav-link">
        <a href="{% url 'admin_page' %}" class="nav-link">{% trans "Dashboard" %}</a>
        <a href="{% url 'all_reservations' %}" class="nav-link">{% trans "All Reservations" %}</a>
        <a href="{% url 'pending_enrichments_page' %}" class="nav-link">{% trans "Pending Enrichments" %}</a>
        <a href="{% url 'enrichment_logs_page' %}" class="nav-link">{% trans "Enrichment Logs" %}</a>
        <a href="{% url 'xls_upload_page' %}" class="nav-link">{% trans "XLS Upload" %}</a>
        <a href="{% url 'message_templates' %}" class="nav-link">{% trans "Message Templates" %}</a>
        {% if 'main.can_give_access' in perms %}
            <a href="{% url 'give_access' %}" class="nav-link">{% trans "Open Doors" %}</a>
        {% endif %}
        {% if 'main.manage_rooms' in perms %}
            <a href="{% url 'room_management' %}" class="nav-link">{% trans "Manage Rooms" %}</a>
        {% endif %}
        {% if user.is_superuser %}
            <a href="{% url 'user_management' %}" class="nav-link">{% trans "Manage Admins" %}</a>
            <a href="{% url 'price_suggester' %}" class="nav-link">{% trans "Price Suggester" %}</a>
            <a href="{% url 'audit_logs' %}" class="nav-link">{% trans "Audit Logs" %}</a>
            <a href="{% url 'block_review_messages' %}" class="nav-link">{% trans "Block Review Messages" %}</a>
        {% endif %}
    </div>

    <h1>üìã {% trans "Pending Enrichments Dashboard" %}</h1>
    <p class="page-subtitle">{% trans "Monitor and manage iCal-driven reservation enrichment workflow" %}</p>

    <!-- Summary Info Box -->
    <div class="info-box">
        <p><strong>{% trans "Unenriched Reservations:" %}</strong> {{ total_unenriched }}</p>
        <p><strong>{% trans "Recently Enriched:" %}</strong> {{ total_enriched }}</p>
        {% if old_pending_count > 0 %}
        <p><strong>{% trans "Old Model Pending:" %}</strong> {{ old_pending_count }} <small>(Legacy email-driven flow)</small></p>
        {% endif %}
        <p><em>{% trans "This page shows the new iCal-driven enrichment workflow. Reservations are auto-synced from iCal feeds and enriched via email search or SMS." %}</em></p>
    </div>

    <!-- Section 1: Unenriched Reservations -->
    <div class="section-header">
        <h2 class="section-title">üîç {% trans "Unenriched Reservations" %}</h2>
        <span class="section-count">{{ total_unenriched }}</span>
    </div>

    {% if unenriched_reservations %}
    <p class="pagination-info" id="unenriched-info"></p>
    <div class="table-container">
        <table id="unenriched-table">
            <thead>
                <tr>
                    <th>{% trans "Room" %}</th>
                    <th>{% trans "Check-In" %}</th>
                    <th>{% trans "Check-Out" %}</th>
                    <th>{% trans "Nights" %}</th>
                    <th>{% trans "Platform" %}</th>
                    <th>{% trans "Status" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for res in unenriched_reservations %}
                <tr>
                    <td><strong>{{ res.room.name }}</strong></td>
                    <td>{{ res.check_in_date|date:"d M Y" }}</td>
                    <td>{{ res.check_out_date|date:"d M Y" }}</td>
                    <td>{{ res.nights }}</td>
                    <td>{{ res.platform }}</td>
                    <td>
                        <span class="badge badge-{{ res.badge_class }}">{{ res.status }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="pagination" id="unenriched-pagination"></div>
    {% else %}
    <div class="empty-state">
        <h3>‚úÖ {% trans "All Clear!" %}</h3>
        <p>{% trans "No unenriched reservations awaiting enrichment." %}</p>
    </div>
    {% endif %}

    <!-- Section 2: Recently Enriched Reservations -->
    <div class="section-header" style="margin-top: 50px;">
        <h2 class="section-title">‚úÖ {% trans "Recently Enriched" %}</h2>
        <span class="section-count">{{ total_enriched }}</span>
    </div>

    {% if enriched_reservations %}
    <p class="pagination-info" id="enriched-info"></p>
    <div class="table-container">
        <table id="enriched-table">
            <thead>
                <tr>
                    <th>{% trans "Booking Ref" %}</th>
                    <th>{% trans "Room" %}</th>
                    <th>{% trans "Check-In" %}</th>
                    <th>{% trans "Check-Out" %}</th>
                    <th>{% trans "Nights" %}</th>
                    <th>{% trans "Method" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for res in enriched_reservations %}
                <tr>
                    <td><strong>{{ res.booking_reference }}</strong></td>
                    <td>{{ res.room.name }}</td>
                    <td>{{ res.check_in_date|date:"d M Y" }}</td>
                    <td>{{ res.check_out_date|date:"d M Y" }}</td>
                    <td>{{ res.nights }}</td>
                    <td>
                        {% if "Auto" in res.method %}
                            <span class="method-badge method-auto">{{ res.method }}</span>
                        {% elif "XLS" in res.method %}
                            <span class="method-badge method-xls">{{ res.method }}</span>
                        {% else %}
                            <span class="method-badge method-manual">{{ res.method }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="pagination" id="enriched-pagination"></div>
    {% else %}
    <div class="empty-state">
        <p>{% trans "No enriched reservations yet." %}</p>
    </div>
    {% endif %}

    <!-- Section 3: Recent Enrichment Logs -->
    <div class="section-header" style="margin-top: 50px;">
        <h2 class="section-title">üìù {% trans "Recent Enrichment Logs" %}</h2>
        <span class="section-count">{{ total_logs }}</span>
    </div>

    {% if enrichment_logs %}
    <p class="pagination-info" id="logs-info"></p>
    <div class="table-container">
        <table id="logs-table">
            <thead>
                <tr>
                    <th>{% trans "Timestamp" %}</th>
                    <th>{% trans "Action" %}</th>
                    <th>{% trans "Booking Ref" %}</th>
                    <th>{% trans "Room" %}</th>
                    <th>{% trans "Method" %}</th>
                    <th>{% trans "Details" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for log in enrichment_logs %}
                <tr>
                    <td class="timestamp">{{ log.timestamp|date:"d M Y H:i:s" }}</td>
                    <td>{{ log.action }}</td>
                    <td><strong>{{ log.booking_reference }}</strong></td>
                    <td>{{ log.room }}</td>
                    <td>{{ log.method }}</td>
                    <td class="details-cell" title="{{ log.details }}">{{ log.details|truncatechars:50 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="pagination" id="logs-pagination"></div>
    {% else %}
    <div class="empty-state">
        <p>{% trans "No enrichment logs yet." %}</p>
    </div>
    {% endif %}
</div>

<!-- JavaScript Pagination (3 separate tables) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generic pagination function
    function setupPagination(tableId, infoId, controlsId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const paginationInfo = document.getElementById(infoId);
        const paginationControls = document.getElementById(controlsId);

        const rowsPerPage = 10;
        let currentPage = 1;
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        function displayPage(page) {
            currentPage = page;
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? "" : "none";
            });

            const showing = Math.min(end, rows.length);
            paginationInfo.textContent = `Showing ${start + 1}-${showing} of ${rows.length}`;

            renderPaginationControls();
        }

        function renderPaginationControls() {
            paginationControls.innerHTML = "";

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement("button");
            prevBtn.textContent = "‚Üê";
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener("click", () => displayPage(currentPage - 1));
            paginationControls.appendChild(prevBtn);

            // Page numbers
            const pagesToShow = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    pagesToShow.push(i);
                }
            } else {
                if (currentPage <= 3) {
                    pagesToShow.push(1, 2, 3, 4, "...", totalPages);
                } else if (currentPage >= totalPages - 2) {
                    pagesToShow.push(1, "...", totalPages - 3, totalPages - 2, totalPages - 1, totalPages);
                } else {
                    pagesToShow.push(1, "...", currentPage - 1, currentPage, currentPage + 1, "...", totalPages);
                }
            }

            pagesToShow.forEach(page => {
                if (page === "...") {
                    const ellipsis = document.createElement("span");
                    ellipsis.textContent = "...";
                    ellipsis.style.padding = "8px";
                    paginationControls.appendChild(ellipsis);
                } else {
                    const pageBtn = document.createElement("button");
                    pageBtn.textContent = page;
                    pageBtn.className = page === currentPage ? "active" : "";
                    pageBtn.addEventListener("click", () => displayPage(page));
                    paginationControls.appendChild(pageBtn);
                }
            });

            // Next button
            const nextBtn = document.createElement("button");
            nextBtn.textContent = "‚Üí";
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener("click", () => displayPage(currentPage + 1));
            paginationControls.appendChild(nextBtn);
        }

        displayPage(1);
    }

    // Setup pagination for all three tables
    setupPagination('unenriched-table', 'unenriched-info', 'unenriched-pagination');
    setupPagination('enriched-table', 'enriched-info', 'enriched-pagination');
    setupPagination('logs-table', 'logs-info', 'logs-pagination');
});
</script>
{% endblock %}

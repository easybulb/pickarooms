{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/room_detail.css' %}">
{% endblock %}

{% block title %}{{ room.name }} - {% trans "Room Details" %}{% endblock %}

{% block content %}

<!-- Hero Section with Image and Playable Video -->
<section class="room-hero">
    <div class="hero-overlay"></div>
    <div class="room-hero-content">
        <img src="{{ image_url }}" alt="{{ room.name }}" class="room-hero-image" id="heroImage">
        <button class="play-button" id="playVideo">
            <i class="fas fa-play"></i>
        </button>
        <p class="play-text" style="font-weight: 400;">{% trans "Instruction Video" %}</p>
    </div>
    <div class="room-video-container" id="videoContainer" style="display: none;">
        <iframe id="videoFrame" src="{{ room.video_url }}" title="{% trans 'Room Instructions' %}" frameborder="0"
            allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
    </div>
</section>

<!-- Room Name & Guest Info -->
<section class="room-header">
    <h1>{{ room.name }}</h1>
    {% if guest %}
    {% blocktrans with guest_name=guest.full_name %}<p>Welcome, {{ guest_name }}</p>{% endblocktrans %}
    {% endif %}
</section>

<!-- Sticky Tab Navigation -->
<div class="section-nav">
    <button class="tab-btn active" onclick="showSection('pin-section')">{% trans "PIN" %}</button>
    <button class="tab-btn" onclick="showSection('location-section')">{% trans "Location" %}</button>
    <button class="tab-btn" onclick="showSection('checkin-section')">{% trans "Check-In" %}</button>
    <button class="tab-btn" onclick="showSection('checkout-section')">{% trans "Check-Out" %}</button>
    <button class="tab-btn" onclick="showSection('faq-section')">{% trans "FAQs" %}</button>
</div>

<!-- PIN Section with Check-In Wizard -->
<section id="pin-section" class="room-container active">
    <div class="room-info">
        <!-- Check-In Wizard -->
        <section id="checkin-wizard">
            <div id="wizard-step-1" class="wizard-step active">
                <h2>ğŸ”‘ {% trans "Your Access PINs" %}</h2>
                {% if not show_pin %}
                <p class="pin-wait">{% trans "Check-in starts at 2 PM UK time. Your PINs will be available then." %}</p>
                {% else %}
                <h3>{% trans "Front Door PIN (TTLock)" %}</h3>
                <p class="pin-code">{{ front_door_pin|default:"Contact support for PIN" }}</p>
                <p class="pin-validity">
                    {% trans "Valid from" %} {{ guest.check_in_date }} 2:00 PM {% trans "to" %} {{ guest.check_out_date }} 11:00 AM
                </p>
                <h3>{% trans "Room Door PIN (Tuya)" %}</h3>
                <p class="pending-note">{% trans "Tuya lock setup pending. Please use the keycard inside your room to access your room door, as shown in the video." %}</p>
                <div class="pin-confirmation">
                    <h3>{% trans "Did the front door PIN work?" %}</h3>
                    <button id="pin-yes" class="pin-btn">{% trans "Yes" %}</button>
                    <button id="pin-no" class="pin-btn" onclick="openModal('pin-help-modal')">{% trans "No" %}</button>
                </div>
                <button class="next-btn" onclick="nextStep(2)">{% trans "Next" %} â†’</button>
                {% endif %}
            </div>

            <div id="wizard-step-2" class="wizard-step">
                <h2>ğŸ¥ {% trans "How to Enter" %}</h2>
                <p>{% trans "Watch the instruction video at the top of the page for entry details." %}</p>
                <button class="watch-video-btn" onclick="scrollToHeroVideo()">{% trans "Watch Video" %}</button>
                <button class="next-btn" onclick="nextStep(3)">{% trans "Next" %} â†’</button>
            </div>

            <div id="wizard-step-3" class="wizard-step">
                <h2>ğŸ“œ {% trans "FAQs & Support" %}</h2>
                <p>{% trans "Need help? Browse our FAQs or contact support via WhatsApp." %}</p>
                <button class="faq-btn" onclick="showSection('faq-section')">{% trans "View FAQs" %}</button>
                <button class="next-btn" onclick="finishCheckin()">{% trans "Finish" %} âœ…</button>
            </div>
        </section>

        <!-- Quick Access Menu (Appears After Wizard Completion) -->
        <div id="quick-access" style="display: none;">
            <button onclick="openQuickAccess('pin')">ğŸ”‘ {% trans "View My PIN" %}</button>
            <button onclick="openQuickAccess('video')">ğŸ¥ {% trans "Watch Video Again" %}</button>
            <button onclick="openQuickAccess('faq')">ğŸ“œ {% trans "FAQs & Help" %}</button>
        </div>
    </div>
</section>

<!-- Location Section -->
<section id="location-section" class="room-container">
    <div class="room-info">
        <h2>ğŸ“ {% trans "Location" %}</h2>
        <p><strong>{% trans "Address:" %}</strong> {% trans "8 Rylance Street, Beswick, Manchester, M11 3NP" %}</p>
        <p><a href="https://maps.google.com?q=8+Rylance+Street,+M11+3NP" target="_blank">{% trans "ğŸ“ Open in Google Maps" %}</a></p>
        <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739857805/property-image_jvfznl.png" alt="{% trans 'Street View of Property' %}" class="street-image">
        <hr>
        <h3>{% trans "How do I get to the property?" %}</h3>
        <p><strong>{% trans "From Manchester Airport:" %}</strong></p>
        <ul>
            <li>ğŸš• <strong>{% trans "Taxi:" %}</strong> {% trans "25 minutes from Manchester Airport." %}</li>
            <li>ğŸš† <strong>{% trans "Train:" %}</strong> {% trans "To Piccadilly Station, then a Â£5 taxi ride." %}</li>
            <li>ğŸšŒ <strong>{% trans "Bus:" %}</strong> {% trans "219 bus from Piccadilly stops nearby." %}</li>
        </ul>
        <p><strong>{% trans "From Manchester:" %}</strong> {% trans "Take the 219 bus from the city centre." %}</p>
        <p><strong>{% trans "Driving:" %}</strong> {% trans "Use Google Maps to 8 Rylance Street, via Ashton Old Road (A635) or M60 Exit 24." %}</p>
    </div>
</section>

<!-- Check-In Section -->
<section id="checkin-section" class="room-container">
    <div class="room-info">
        <h2>ğŸ“¥ {% trans "Check-In" %}</h2>
        {% if guest %}
        <p><strong>{% trans "Date:" %}</strong> {{ guest.check_in_date }} ({% trans "From 2 PM" %})</p>
        <p><strong>{% trans "Reservation Number:" %}</strong> {{ guest.reservation_number }}</p>
        {% else %}
        <p class="no-guest">âŒ {% trans "No guest assigned to this room. Contact admin for assistance." %}</p>
        {% endif %}
        <hr>
        <h3>{% trans "How do I use my PINs?" %}</h3>
        <h4>{% trans "Front Door (TTLock)" %}</h4>
        <ol>
            <li>{% trans "Watch the video at the top of this page for easy instructions." %}</li>
            <li>{% trans "When you arrive at the propertyâ€™s front door, touch the keypad area to light up the numbers." %}</li>
            <li>{% trans "Enter your PIN:" %} <span class="pin-code">{{ front_door_pin|default:"Contact support" }}</span></li>
            <li>{% trans "Once inside, remove your shoes and make your way upstairs to find" %} <strong>{{ room.name }}</strong>.</li>
        </ol>
        <h4>{% trans "Room Door (Tuya)" %}</h4>
        <p class="pending-note">{% trans "Tuya lock setup pending. Please use the keycard inside your room to access your room door, as shown in the video." %}</p>
        <ol start="5">
            <li>{% trans "Inside your room, find a" %} <strong>{% trans "keycard" %}</strong>. {% trans "Use it to enter/exit your room. Watch the video above for keycard use." %}</li>
        </ol>
    </div>
</section>

<!-- Check-Out Section -->
<section id="checkout-section" class="room-container">
    <div class="room-info">
        <h2>ğŸ“¤ {% trans "Check-Out" %}</h2>
        {% if guest %}
        <p><strong>{% trans "Date:" %}</strong> {{ guest.check_out_date }} ({% trans "Before 11 AM" %})</p>
        <p class="expiration"><strong>{% trans "Access Expires:" %}</strong> {{ expiration_message }}</p>
        <p class="expiration-note">{% trans "Note: Your front door PIN will expire at check-out time. Please ensure you check out before 11 AM to avoid being locked out." %}</p>
        {% else %}
        <p class="no-guest">âŒ {% trans "No guest assigned to this room. Contact admin for assistance." %}</p>
        {% endif %}
        <hr>
        <h3>{% trans "How do I check out?" %}</h3>
        <ul>
            <li>ğŸ›‘ <strong>{% trans "Leave keycard:" %}</strong> {% trans "Inside room, visible." %}</li>
            <li>ğŸ”Œ <strong>{% trans "Switch off:" %}</strong> {% trans "All appliances and lights." %}</li>
            <li>ğŸšª <strong>{% trans "Close door:" %}</strong> {% trans "Securely." %}</li>
            <li>ğŸ›ï¸ {% trans "Leave towels in bathroom." %}</li>
            <li>ğŸ“… {% trans "Housekeeping enters after 11 AM." %}</li>
        </ul>
    </div>
</section>

<!-- FAQ Section -->
<section id="faq-section" class="room-container">
    <div class="room-info">
        <h2>â“ {% trans "Frequently Asked Questions" %}</h2>
        <input type="text" id="faq-search" placeholder="{% trans 'Search FAQs...' %}" onkeyup="filterFAQs()">
        <div class="faq-container">
            <!-- Access Category -->
            <div class="faq-category">
                <h3 onclick="toggleCategory(this)">{% trans "Access" %}</h3>
                <div class="faq-item">
                    <button class="faq-question">{% trans "Is my digital lock secure?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>{% trans "Our" %} <strong>{% trans "TTLock" %}</strong> {% trans "system for the front door and future Tuya Smart Locks for room doors ensure only the assigned guest and admin can access. PINs expire after checkout for added security." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "What if my front door PIN doesnâ€™t work?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>{% trans "Try the following steps:" %}</p>
                        <ul>
                            <li>{% trans "Ensure youâ€™re entering the correct PIN as shown above." %}</li>
                            <li>{% trans "Touch the keypad to light up the numbers before entering the PIN." %}</li>
                            <li>{% trans "Check the video instructions for proper usage." %}</li>
                            <li>{% trans "If it still doesnâ€™t work, click 'No' in the PIN confirmation section to report the issue, and our team will assist you promptly." %}</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Amenities Category -->
            <div class="faq-category">
                <h3 onclick="toggleCategory(this)">{% trans "Amenities" %}</h3>
                <div class="faq-item">
                    <button class="faq-question">{% trans "Whatâ€™s the WiFi password?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <ul>
                            <li><strong>{% trans "Wifi Name:" %}</strong> {% trans "Guest_2.4G" %}</li>
                            <li><strong>{% trans "Password:" %}</strong> {% trans "welcome1" %}</li>
                        </ul>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "What are the house rules?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <ul>
                            <li>â— {% trans "No smoking inside." %}</li>
                            <li>ğŸ”‘ {% trans "Lost keys incur a fee." %}</li>
                            <li>ğŸ‰ {% trans "No loud noise or parties allowed." %}</li>
                        </ul>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "Where is the shared kitchen?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>ğŸ• {% trans "Downstairs with full access." %}</p>
                        <p>ğŸ• <strong>{% trans "Microwave & Oven:" %}</strong> {% trans "In the kitchen with instructions nearby." %}</p>
                        <p>ğŸ½ <strong>{% trans "Plates & Cutlery:" %}</strong> {% trans "In cabinetsâ€”wash after use." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "How do I adjust the heating?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>â„ï¸ {% trans "Turn radiator knobs" %} <strong>{% trans "anti-clockwise" %}</strong> {% trans "to increase heat." %}</p>
                        <p>ğŸ”¥ {% trans "Heats automatically below" %} <strong>{% trans "21Â°C" %}</strong>.</p>
                        <p>âš ï¸ {% trans "Donâ€™t force stiff knobsâ€”turn gently." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "Whereâ€™s the bathroom, and do you provide towels?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>ğŸš¿ <strong>{% trans "Bathrooms:" %}</strong> {% trans "En-suite or shared in the hallway." %}</p>
                        <p>ğŸ› {% trans "Fresh towels and shower gel provided in your room." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "Do you provide a pressing iron and hairdryer?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>ğŸ§º <strong>{% trans "Pressing iron:" %}</strong> {% trans "In the hallway." %}</p>
                        <p>ğŸ’¨ <strong>{% trans "Hairdryer:" %}</strong> {% trans "In the bathroom." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "How safe is the internet network?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>{% trans "Powered by" %} <strong>{% trans "Fibre One" %}</strong> {% trans "and secured with an" %} <strong>{% trans "Eero 6+ Gateway" %}</strong>. {% trans "Guest network is isolated." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "What amenities are included?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <ul>
                            <li>âœ… {% trans "Free High-Speed WiFi" %}</li>
                            <li>âœ… {% trans "Fresh Towels & Bed Linen" %}</li>
                            <li>âœ… {% trans "Private or Shared Bathroom with body wash and hand wash" %}</li>
                            <li>âœ… {% trans "Smart TV with Netflix, Amazon Prime" %}</li>
                            <li>âœ… {% trans "Pressing Iron and Hair Dryer" %}</li>
                            <li>âœ… {% trans "Complimentary Tea, Coffee & Milk (in kitchen)" %}</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Travel Category -->
            <div class="faq-category">
                <h3 onclick="toggleCategory(this)">{% trans "Travel" %}</h3>
                <div class="faq-item">
                    <button class="faq-question">{% trans "How can I get around?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>ğŸš• <strong>{% trans "Taxi:" %}</strong> {% trans "Uber, Bolt, or StreetCars (+44 161 223 1066)." %}</p>
                        <p>ğŸš‡ <strong>{% trans "Metro:" %}</strong> {% trans "219 bus from Ashton-Old-Road to city centre." %}</p>
                        <p><a href="https://tfgm.com/" target="_blank">{% trans "Bee Network" %}</a> {% trans "for bus routes." %}</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">{% trans "Where can I park?" %} <span class="arrow">â–¼</span></button>
                    <div class="faq-answer">
                        <p>âœ… <strong>{% trans "Free parking:" %}</strong> {% trans "On-site." %}</p>
                        <p>âœ… {% trans "Tarmac fits two carsâ€”park left if first." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- PIN Help Modal -->
<div id="pin-help-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('pin-help-modal')">Ã—</span>
        <h3>{% trans "Need Help with Your PIN?" %}</h3>
        <p>{% trans "Watch these videos for assistance:" %}</p>
        <div class="video-wrapper">
            <div class="video-item">
                <h4>{% trans "Front Door" %}</h4>
                <div class="video-overlay">
                    <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739857805/property-image_jvfznl.png" alt="{% trans 'Front Door Preview' %}" class="video-preview-image">
                    <button class="play-button" data-video="front-door-video">
                        <i class="fas fa-play"></i>
                    </button>
                    <p class="play-text">{% trans "Watch Video" %}</p>
                </div>
                <div class="modal-video-container" id="front-door-video" style="display: none;">
                    <iframe src="https://www.youtube.com/embed/cEDr1tXnmhQ?enablejsapi=1" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="video-item">
                <h4>{% trans "Room Door" %}</h4>
                <div class="video-overlay">
                    <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739857805/property-image_jvfznl.png" alt="{% trans 'Room Door Preview' %}" class="video-preview-image">
                    <button class="play-button" data-video="room-door-video">
                        <i class="fas fa-play"></i>
                    </button>
                    <p class="play-text">{% trans "Watch Video" %}</p>
                </div>
                <div class="modal-video-container" id="room-door-video" style="display: none;">
                    <iframe src="https://www.youtube.com/embed/cEDr1tXnmhQ?enablejsapi=1" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>
        <div id="pin-admin-alert" class="hidden">
            <p>{% trans "Still not working? A team member will contact you soon. Or call/WhatsApp us at" %} <strong>+44(0)7539029629</strong>.</p>
        </div>
        <p><button id="pin-still-issue" class="pin-btn">{% trans "Still Doesnâ€™t Work" %}</button></p>
    </div>
</div>

<!-- WhatsApp Chat Button -->
<div id="chat-button" onclick="toggleChat()">{% trans "ğŸ’¬ Chat with Me" %}</div>
<div class="chat-box" id="chatBox">
    <p>{% trans "Need help? Send me a message on WhatsApp!" %}</p>
    <a href="https://wa.me/447539029629" target="_blank">{% trans "Open WhatsApp" %}</a>
</div>

<!-- JavaScript -->
<script>
// Global functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showSection(sectionId) {
    document.querySelectorAll('.room-container').forEach(section => section.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');
}

document.addEventListener("DOMContentLoaded", function () {
    // Reset wizard state on page load
    document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
    document.getElementById('wizard-step-1').classList.add('active');
    let currentStep = 1;
    document.getElementById("quick-access").style.display = "none";

    // PIN Confirmation (Updated for Wizard)
    const pinYes = document.getElementById("pin-yes");
    const pinNo = document.getElementById("pin-no");
    const pinStillIssue = document.getElementById("pin-still-issue");
    const pinAdminAlert = document.getElementById("pin-admin-alert");

    if (pinYes) pinYes.addEventListener("click", () => {
        alert("Enjoy your stay!");
        // Show quick access menu after PIN confirmation
        document.getElementById("quick-access").style.display = "flex";
    });
    if (pinNo) pinNo.addEventListener("click", () => openModal("pin-help-modal"));
    if (pinStillIssue) {
        pinStillIssue.addEventListener("click", function () {
            pinAdminAlert.style.display = "block";
            fetch("/report_pin_issue/", {
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/json" },
                credentials: "same-origin"
            })
            .then(response => response.json())
            .then(data => {
                pinAdminAlert.innerHTML = data.success ? `<p>${data.success}</p>` : `<p style="color: red;">${data.error}</p>`;
            })
            .catch(() => pinAdminAlert.innerHTML = `<p style="color: red;">Error occurred. Try again.</p>`);
        });
    }

    function getCSRFToken() {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            if (cookie.trim().startsWith("csrftoken=")) return cookie.split("=")[1];
        }
        return null;
    }

    // Wizard Navigation
    window.nextStep = function (step) {
        document.getElementById(`wizard-step-${currentStep}`).classList.remove("active");
        document.getElementById(`wizard-step-${step}`).classList.add("active");
        currentStep = step;
    };

    window.finishCheckin = function () {
        alert("âœ… Check-in complete! Enjoy your stay.");
        document.getElementById("quick-access").style.display = "flex";
    };

    // Quick Access Menu Functionality
    window.openQuickAccess = function (section) {
        if (section === "pin") {
            {% if show_pin %}
            alert("ğŸ”‘ Your Front Door PIN: " + document.querySelector(".pin-code").textContent);
            {% else %}
            alert("ğŸ”‘ Check-in starts at 2 PM UK time. Your PINs will be available then.");
            {% endif %}
        } else if (section === "video") {
            scrollToHeroVideo();
        } else if (section === "faq") {
            showSection('faq-section');
        }
    };

    // Scroll to Hero Video
    window.scrollToHeroVideo = function () {
        const heroImage = document.getElementById("heroImage");
        const videoContainer = document.getElementById("videoContainer");
        const playButton = document.getElementById("playVideo");
        const playText = document.querySelector(".play-text");
        const heroOverlay = document.querySelector(".hero-overlay");
        const iframe = document.getElementById("videoFrame");

        heroImage.style.display = "none";
        playButton.style.display = "none";
        playText.style.display = "none";
        heroOverlay.style.display = "none";
        videoContainer.style.display = "flex";
        let videoSrc = iframe.src;
        if (!videoSrc.includes("autoplay=1")) {
            iframe.src = videoSrc + (videoSrc.includes("?") ? "&" : "?") + "autoplay=1";
            console.log('Hero video src set to:', iframe.src);
        }
        heroImage.scrollIntoView({ behavior: "smooth" });
    };

    // Hero Video
    const heroImage = document.getElementById("heroImage");
    const videoContainer = document.getElementById("videoContainer");
    const playButton = document.getElementById("playVideo");
    const playText = document.querySelector(".play-text");
    const heroOverlay = document.querySelector(".hero-overlay");
    const iframe = document.getElementById("videoFrame");

    playButton.addEventListener("click", function () {
        heroImage.style.display = "none";
        playButton.style.display = "none";
        playText.style.display = "none";
        heroOverlay.style.display = "none";
        videoContainer.style.display = "flex";
        let videoSrc = iframe.src;
        if (!videoSrc.includes("autoplay=1")) {
            iframe.src = videoSrc + (videoSrc.includes("?") ? "&" : "?") + "autoplay=1";
            console.log('Hero video src set to:', iframe.src);
        }
    });

    // FAQ Toggle
    document.querySelectorAll(".faq-question").forEach(item => {
        item.addEventListener("click", () => {
            const answer = item.nextElementSibling;
            const arrow = item.querySelector(".arrow");
            const isActive = answer.style.display === "block";
            answer.style.display = isActive ? "none" : "block";
            arrow.textContent = isActive ? "â–¼" : "â–²";
        });
    });

    window.filterFAQs = function () {
        const input = document.getElementById("faq-search").value.toLowerCase();
        const items = document.querySelectorAll(".faq-item");
        let visibleCount = 0;

        items.forEach(item => {
            const question = item.querySelector(".faq-question").textContent.toLowerCase();
            const answer = item.querySelector(".faq-answer");
            const answerText = answer.textContent.toLowerCase();
            const matches = question.includes(input) || answerText.includes(input);

            if (input === "") {
                answer.style.display = "none"; // Reset answers to hidden
                answer.classList.remove('highlight');
            } else {
                answer.style.display = matches ? "block" : "none";
                if (matches) {
                    visibleCount++;
                    answer.classList.toggle('highlight', question.includes(input) || answerText.includes(input));
                    const category = item.closest('.faq-category');
                    if (!category.classList.contains('active')) {
                        category.classList.add('active');
                    }
                } else {
                    answer.classList.remove('highlight');
                }
            }
        });

        const noResults = document.getElementById("faq-no-results");
        if (noResults) noResults.classList.toggle('hidden', visibleCount > 0);
    };

    // FAQ Category Toggle
    window.toggleCategory = function (header) {
        const category = header.parentElement;
        category.classList.toggle("active");
    };

    // Chat Button
    window.toggleChat = function () {
        document.getElementById("chatBox").classList.toggle("show");
    };

    // Modal Video Playback
    document.querySelectorAll('.video-item .play-button').forEach(button => {
        button.addEventListener('click', function () {
            const videoId = this.getAttribute('data-video');
            const videoContainer = document.getElementById(videoId);
            const overlay = this.closest('.video-overlay');
            const previewImage = overlay.querySelector('.video-preview-image');
            const playText = overlay.querySelector('.play-text');
            const iframe = videoContainer.querySelector('iframe');

            console.log('Modal play button clicked, videoId:', videoId);

            // Hide overlay elements
            overlay.style.display = 'none'; // Hide entire overlay
            // Show and play video container
            videoContainer.style.display = 'block'; // Changed to block for simplicity
            let videoSrc = iframe.src;
            if (!videoSrc.includes("autoplay=1")) {
                iframe.src = videoSrc + (videoSrc.includes("?") ? "&" : "?") + "autoplay=1&rel=0";
                console.log('Modal video src set to:', iframe.src);
            }
        });
    });
});
</script>

{% endblock %}
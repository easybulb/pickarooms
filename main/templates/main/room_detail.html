{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/room_detail.css' %}">
{% endblock %}

{% block title %}{{ room.name }} - {% trans "Room Details" %}{% endblock %}

{% block content %}

<!-- ✅ Hero Section with Image and Playable Video -->
<section class="room-hero">
    <div class="hero-overlay"></div>

    <!-- ✅ Default Room Image -->
    <div class="room-hero-content">
        <img src="{{ image_url }}" alt="{{ room.name }}" class="room-hero-image" id="heroImage">
        <button class="play-button" id="playVideo">
            <i class="fas fa-play"></i>
        </button>
        <p class="play-text" style="font-weight: 400;">{% trans "Instruction Video" %}</p> <!-- ✅ Play Video Text -->
    </div>

    <!-- ✅ Hidden Video (Revealed on Click) -->
    <div class="room-video-container" id="videoContainer" style="display: none;">
        <iframe id="videoFrame" src="{{ room.video_url }}" title="{% trans 'Room Instructions' %}" frameborder="0"
            allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen>
        </iframe>
    </div>
</section>

<!-- ✅ Room Name & Guest Info -->
<section class="room-header">
    <h1>{{ room.name }}</h1>
    {% if guest %}
    {% blocktrans with guest_name=guest.full_name %}<p>Welcome, {{ guest_name }}</p>{% endblocktrans %}
    {% endif %}
</section>

<!-- ✅ Room Details -->
<section class="room-container">
    <div class="room-info">
        <h2>{% trans "🔑 House & Room Access PIN" %}</h2>
        {% if not show_pin %}
        <p class="pin-wait">{% trans "Check-in starts at 2 PM UK time. Your PIN will be available then." %}</p>
        {% else %}
        {% if room.access_pin %}
        <p class="pin-code">{{ room.access_pin }}</p>
        {% else %}
        <p class="pin-code">{% trans "No PIN assigned yet. Contact support." %}</p>
        {% endif %}

        <!-- ✅ PIN Confirmation Section -->
        <div class="pin-confirmation">
            <h3>Did the PIN work for you?</h3>
            <div class="buttons">
                <button id="pin-yes" class="pin-btn">Yes</button>
                <button id="pin-no" class="pin-btn">No</button>
            </div>
        </div>

        <div id="pin-success" class="hidden">
            <p>Enjoy your stay! Below are the PIN instruction videos in case you need it.</p>
            <div class="video-wrapper">
                <div class="video-container">
                    <h3 class="video-h3">Front Door</h3>
                    <button id="back" class="back-btn"><i class="fas fa-arrow-left"></i> <span>Back</span></button>
                    <iframe src="https://www.youtube.com/embed/cEDr1tXnmhQ" frameborder="0" allowfullscreen></iframe>
                </div>
                <div class="video-container">
                    <h3 class="video-h3">Room Door</h3>
                    <button id="back" class="back-btn"><i class="fas fa-arrow-left"></i> <span>Back</span></button>
                    <iframe src="https://www.youtube.com/embed/8BbQ30RFx5U" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>

        <div id="pin-issue" class="hidden">
            <h3>Watch these videos for help:</h3>
            <div class="video-wrapper">
                <div class="video-container">
                    <h3 class="video-h3">Front Door</h3>
                    <button id="back" class="back-btn"><i class="fas fa-arrow-left"></i> <span>Back</span></button>
                    <iframe src="https://www.youtube.com/embed/cEDr1tXnmhQ" frameborder="0" allowfullscreen></iframe>
                </div>
                <div class="video-container">
                    <h3 class="video-h3">Room Door</h3>
                    <button id="back" class="back-btn"><i class="fas fa-arrow-left"></i> <span>Back</span></button>
                    <iframe src="https://www.youtube.com/embed/8BbQ30RFx5U" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <h3>Does it work now?</h3>
            <button id="pin-fixed" class="pin-btn">Yes</button>
            <button id="pin-still-issue" class="pin-btn">Still Doesn’t Work</button>
        </div>

        <div id="pin-admin-alert" class="hidden">
            <p>A member of our team will contact you shortly. You can also call or WhatsApp us on
                <strong>+44(0)7539029629</strong>.
            </p>
        </div>
        {% endif %}

        <h2>{% trans "🛏️ Room Details" %}</h2>
        <p>{{ room.description }}</p>

        {% if guest %}
        <h2>{% trans "📅 Your Stay" %}</h2>
        <p><strong>{% trans "Reservation Number:" %}</strong> {{ guest.reservation_number }}</p>
        <p><strong>{% trans "Check-In:" %}</strong> {{ guest.check_in_date }} ({% trans "From 2 PM" %})</p>
        <p><strong>{% trans "Check-Out:" %}</strong> {{ guest.check_out_date }} ({% trans "Before 11 AM" %})</p>
        <p class="expiration"><strong>{% trans "Access Expires:" %}</strong> {{ expiration_message }}</p>
        {% else %}
        <p class="no-guest">❌ {% trans "No guest assigned to this room. Contact admin for assistance." %}</p>
        {% endif %}
    </div>
    <br>
    <!-- ✅ FAQ Section -->
    <div id="faq" class="room-info">
        <h2>{% trans "❓ Frequently Asked Questions" %}</h2>
        <div class="faq-container">

            <!-- ✅ House Address -->
            <div class="faq-item">
                <button class="faq-question">{% trans "📍 Where is the property located?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p><strong>{% trans "8 Rylance Street, Beswick, Manchester, M11 3NP" %}</strong></p>
                    <p>
                        <a href="https://maps.google.com?q=8+Rylance+Street,+M11+3NP" target="_blank">
                            {% trans "📍 Open in Google Maps" %}
                        </a>
                    </p>
                    <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739857805/property-image_jvfznl.png"
                        alt="{% trans 'Street View of Property' %}" class="street-image">
                </div>
            </div>

            <!-- ✅ Directions to Property -->
            <div class="faq-item">
                <button class="faq-question">{% trans "How do I get to the property?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p><strong>{% trans "Coming from Manchester Airport?" %}</strong></p>
                    <ul>
                        <li>
                            🚕 <strong>{% trans "Taxi:" %}</strong> {% trans "A direct taxi from" %} <strong>{% trans
                                "Manchester Airport" %}</strong> {% trans "takes approximately 25 minutes." %}
                        </li>
                        <li>
                            🚆 <strong>{% trans "Train:" %}</strong> {% trans "Take a train from" %} <strong>{% trans
                                "Manchester Airport to Piccadilly Station" %}</strong>, {% trans "then a short" %}
                            <strong>{% trans "£5 taxi ride" %}</strong> {% trans "to the property." %}
                        </li>
                        <li>
                            🚌 <strong>{% trans "Bus:" %}</strong> {% trans "The" %} <strong>{% trans "219 bus"
                                %}</strong> {% trans "from" %} <strong>{% trans "Piccadilly Station" %}</strong> {%
                            trans "stops near the property." %}
                        </li>
                    </ul>

                    <p><strong>{% trans "Coming from another part of Manchester?" %}</strong></p>
                    <p>
                        {% trans "Make your way to" %} <strong>{% trans "Manchester city centre" %}</strong> {% trans
                        "and take the" %} <strong>{% trans "219 bus" %}</strong> {% trans "to the nearest bus stop close
                        to the property. You can use" %} <strong>{% trans "Google Maps" %}</strong> {% trans "or your
                        navigation app to find the closest stop to alight." %}
                    </p>

                    <p><strong>{% trans "Driving to the property?" %}</strong></p>
                    <p>
                        {% trans "Use" %} <strong>{% trans "Google Maps" %}</strong> {% trans "or your preferred
                        navigation app and enter the destination:" %}
                    </p>
                    <p><strong>{% trans "8 Rylance Street, Beswick, Manchester, M11 3NP" %}</strong></p>
                    <p>
                        {% trans "The property is easily accessible via" %} <strong>{% trans "Ashton Old Road (A635)"
                            %}</strong>. {% trans "If coming from the" %} <strong>{% trans "M60 motorway" %}</strong>,
                        {% trans "take Exit 24 and follow signs toward" %} <strong>{% trans "Manchester City Centre"
                            %}</strong>. {% trans "Parking is available on-site." %}
                    </p>
                </div>
            </div>

            <!-- ✅ How to Use PIN -->
            <div class="faq-item">
                <button class="faq-question">{% trans "How do I use the PIN?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <ol>
                        <li>{% trans "Watch the video at the top of this page for easy instructions." %}</li>
                        <li>{% trans "When you arrive at the property’s front door, touch the keypad area to light up
                            the numbers." %}</li>
                        <li>
                            {% trans "Enter your PIN:" %}
                            {% if not show_pin %}
                            <p class="pin-wait">{% trans "Check-in starts at 2 PM UK time. Your PIN will be available
                                then." %}</p>
                            {% else %}
                            {% if room.access_pin %}
                            <p class="pin-code">{{ room.access_pin }}</p>
                            {% else %}
                            <p class="pin-code">{% trans "No PIN assigned yet. Contact support." %}</p>
                            {% endif %}
                            {% endif %}
                        </li>
                        <li>
                            {% trans "Once inside, remove your shoes and make your way upstairs to find" %} <strong>{{
                                room.name }}</strong>.
                        </li>
                        <li>
                            {% trans "Touch the front of the" %} <strong>{{ room.name }}</strong> {% trans "door lock to
                            light up the numbers and enter the same PIN to access your room." %}
                        </li>
                        <li>
                            {% trans "Inside your room, you will find a" %} <strong>{% trans "keycard" %}</strong>. {%
                            trans "You can either continue using your PIN or use the keycard to enter and exit the
                            property and your room. Watch the video above on how to use the keycard." %}
                        </li>
                    </ol>
                </div>
            </div>

            <!-- ✅ Wifi Password -->
            <div class="faq-item">
                <button class="faq-question">{% trans "What is the WiFi password?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "The WiFi details are below." %}</p>
                    <ul>
                        <li><strong>{% trans "Wifi Name:" %}</strong> {% trans "Guest_2.4G" %}</li>
                        <li><strong>{% trans "Password:" %}</strong> {% trans "welcome1" %}</li>
                    </ul>
                </div>
            </div>

            <!-- ✅ House Rules -->
            <div class="faq-item">
                <button class="faq-question">{% trans "What are the house rules?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <ul>
                        <li>❗ {% trans "No smoking inside." %}</li>
                        <li>🔑 {% trans "Lost keys incur a fee." %}</li>
                        <li>🎉 {% trans "No loud noise or parties allowed." %}</li>
                    </ul>
                </div>
            </div>

            <!-- ✅ Kitchen Info -->
            <div class="faq-item">
                <button class="faq-question">{% trans "Where is the shared kitchen?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>🍕 {% trans "The kitchen is located downstairs and you have full access to it." %}</p>
                    <p>🍕 <strong>{% trans "Microwave & Oven:" %}</strong> {% trans "Located in the kitchen.
                        Instructions are available nearby." %}</p>
                    <p>🍽 <strong>{% trans "Plates & Cutlery:" %}</strong> {% trans "Stored in the cabinets. Please wash
                        after use." %}</p>
                </div>
            </div>

            <!-- ✅ Heating Instructions -->
            <div class="faq-item">
                <button class="faq-question">{% trans "How do I adjust the heating?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>❄️ {% trans "To increase the heat, turn both radiator knobs" %} <strong>{% trans "anti-clockwise"
                            %}</strong> {% trans "to allow hot water to flow in." %}</p>
                    <p>🔥 {% trans "The heating system will automatically activate when the room temperature drops
                        below" %} <strong>{% trans "21°C" %}</strong>.</p>
                    <p>⚠️ <strong>{% trans "Note:" %}</strong> {% trans "Do not force the knobs. If they feel stiff,
                        turn them gently." %}</p>
                </div>
            </div>

            <!-- ✅ Transport and Taxi Services -->
            <div class="faq-item">
                <button class="faq-question">{% trans "How can I get around?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>🚕 <strong>{% trans "Recommended Taxi:" %}</strong> {% trans "Uber, Bolt, or StreetCars" %}
                        <strong>{% trans "(+44 161 223 1066)" %}</strong>
                    </p>
                    <p>🚇 <strong>{% trans "Metro:" %}</strong> {% trans "Take" %} <strong>{% trans "bus 219 from
                            Ashton-Old-Road" %}</strong> {% trans "to the city centre." %}</p>
                    <p>{% trans "For more bus routes and planning go to" %} <a href="https://tfgm.com/"
                            target="blank">{% trans "Bee Network" %}</a></p>
                </div>
            </div>

            <!-- ✅ Check-Out Instructions -->
            <div class="faq-item">
                <button class="faq-question">{% trans "How do I check out?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <ul>
                        <li>🛑 <strong>{% trans "Leave the keycard inside the room" %}</strong> {% trans "—anywhere
                            visible." %}</li>
                        <li>🔌 <strong>{% trans "Switch off all electrical appliances" %}</strong> {% trans "and ensure
                            lights are turned off." %}</li>
                        <li>🚪 <strong>{% trans "Close the door securely behind you" %}</strong>.</li>
                        <li>🛏️ <strong>{% trans "Leave used towels" %}</strong> {% trans "in the bathroom." %}</li>
                        <li>📅 <strong>{% trans "Housekeeping staff may enter" %}</strong> {% trans "after the checkout
                            time." %}</li>
                    </ul>
                </div>
            </div>

            <!-- ✅ Parking Info -->
            <div class="faq-item">
                <button class="faq-question">{% trans "🚘 Where can I park?" %} <span class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>✅ <strong>{% trans "Free parking" %}</strong> {% trans "is available on the property." %}</p>
                    <p>✅ {% trans "The tarmac area can accommodate two cars. If you arrive before other guests, please
                        park" %} <strong>{% trans "well to the left" %}</strong> {% trans "to leave enough space for
                        another car to park beside yours." %}</p>
                </div>
            </div>

            <!-- ✅ Bathroom & Towels -->
            <div class="faq-item">
                <button class="faq-question">{% trans "Where is the bathroom, and do you provide towels?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>🚿 <strong>{% trans "Bathrooms & Toilets:" %}</strong> {% trans "Some rooms have en-suite
                        bathrooms, while others have shared bathrooms located in the hallway." %}</p>
                    <p>🛏 {% trans "Fresh towels are provided inside your room. Shower gel is also available in the
                        bathroom for your convenience." %}</p>
                </div>
            </div>

            <!-- ✅ Pressing Iron and Hairdryer -->
            <div class="faq-item">
                <button class="faq-question">{% trans "Do you provide a pressing iron and hairdryer?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>🧺 {% trans "Yes, a" %} <strong>{% trans "pressing iron" %}</strong> {% trans "is available in
                        the hallway for your use." %}</p>
                    <p>💨 <strong>{% trans "hairdryer" %}</strong> {% trans "can be found in the bathroom." %}</p>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "How safe is the internet network?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "Our internet is powered by" %} <strong>{% trans "Fibre One" %}</strong> {% trans "and
                        secured with an" %} <strong>{% trans "Eero 6+ Gateway" %}</strong>. {% trans "The guest network
                        is fully isolated, preventing data sharing between devices." %}</p>
                </div>
            </div>

            <div class="faq-item">
                <button class="faq-question">{% trans "Is my digital lock secure?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "The" %} <strong>{% trans "Tuya Smart Lock" %}</strong> {% trans "ensures only the
                        assigned guest and admin can access the room. PINs automatically expire after checkout, making
                        it highly secure." %}</p>
                </div>
            </div>

            <!-- ✅ Room Amenities -->
            <div class="faq-item">
                <button class="faq-question">{% trans "What amenities are included in the room?" %} <span
                        class="arrow">▼</span></button>
                <div class="faq-answer">
                    <p>{% trans "The room includes the following amenities:" %}</p>
                    <ul>
                        <li>✅ {% trans "Free High-Speed WiFi" %}</li>
                        <li>✅ {% trans "Fresh Towels & Bed Linen" %}</li>
                        <li>✅ {% trans "Private or Shared Bathroom with body wash and hand wash" %}</li>
                        <li>✅ {% trans "Smart TV with Netflix, Amazon Prime and others" %}</li>
                        <li>✅ {% trans "Pressing Iron and Hair Dryer" %}</li>
                        <li>✅ {% trans "Complimentary Tea, Coffee & Milk (In the kitchen downstairs)" %}</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <!-- ✅ WhatsApp Chat Button -->
    <div id="chat-button" class="room-info" onclick="toggleChat()">{% trans "💬 Chat with Me" %}</div>
    <div class="chat-box" id="chatBox">
        <p>{% trans "Need help? Send me a message on WhatsApp!" %}</p>
        <a href="https://wa.me/447539029629" target="_blank">{% trans "Open WhatsApp" %}</a>
    </div>

</section>

<!-- ✅ JavaScript to Control Video and FAQ -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ✅ Get Elements
        const pinYes = document.getElementById("pin-yes");
        const pinNo = document.getElementById("pin-no");
        const pinFixed = document.getElementById("pin-fixed");
        const pinStillIssue = document.getElementById("pin-still-issue");

        const pinSuccess = document.getElementById("pin-success");
        const pinIssue = document.getElementById("pin-issue");
        const pinAdminAlert = document.getElementById("pin-admin-alert");

        // ✅ Hide all sections initially
        if (pinSuccess) pinSuccess.style.display = "none";
        if (pinIssue) pinIssue.style.display = "none";
        if (pinAdminAlert) pinAdminAlert.style.display = "none";

        // ✅ PIN Confirmation Logic
        if (pinYes) {
            pinYes.addEventListener("click", function () {
                pinSuccess.style.display = "block"; // Show success message and video
                pinIssue.style.display = "none"; // Hide issue section if open
                pinAdminAlert.style.display = "none"; // Hide admin alert
            });
        }

        if (pinNo) {
            pinNo.addEventListener("click", function () {
                pinIssue.style.display = "block"; // Show issue help videos
                pinSuccess.style.display = "none"; // Hide success message
                pinAdminAlert.style.display = "none"; // Hide admin alert
            });
        }

        if (pinFixed) {
            pinFixed.addEventListener("click", function () {
                pinIssue.style.display = "none"; // Hide issue section
                pinSuccess.style.display = "none"; // Hide success message
            });
        }

        if (pinStillIssue) {
            pinStillIssue.addEventListener("click", function () {
                pinAdminAlert.style.display = "block"; // Show admin alert
                pinIssue.style.display = "none"; // Hide issue section

                // ✅ Send report to admin
                fetch("/report_pin_issue/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        guest_name: "{{ guest.full_name }}",
                        reservation_number: "{{ guest.reservation_number }}",
                        room_name: "{{ room.name }}"
                    })
                });
            });
        }


        const videoContainers = document.querySelectorAll(".video-container");
        const videoWrapper = document.querySelector(".video-wrapper");
        const backButtons = document.querySelectorAll(".back-btn");

        // Initially hide all back buttons
        backButtons.forEach(button => button.style.display = "none");

        videoContainers.forEach(container => {
            const backButton = container.querySelector(".back-btn");

            container.addEventListener("click", function () {
                // Reset all videos to normal size
                videoContainers.forEach(video => {
                    video.classList.remove("expanded");
                    video.style.display = "block"; // Ensure both are visible again
                    video.querySelector(".back-btn").style.display = "none"; // Hide back button
                });

                // Expand the clicked video and hide the other one
                this.classList.add("expanded");
                videoContainers.forEach(video => {
                    if (video !== this) {
                        video.style.display = "none"; // Hide the other video
                    }
                });

                // Show the back button only for the expanded video
                backButton.style.display = "block";
            });

            // ✅ Back button functionality
            backButton.addEventListener("click", function (event) {
                event.stopPropagation(); // Prevents triggering the video expand event

                // Reset all videos to normal side-by-side layout
                videoContainers.forEach(video => {
                    video.classList.remove("expanded");
                    video.style.display = "block"; // Make both videos visible again
                    video.querySelector(".back-btn").style.display = "none"; // Hide back button again
                });
            });
        });




        // ✅ Select elements
        const heroImage = document.getElementById("heroImage");
        const videoContainer = document.getElementById("videoContainer");
        const playButton = document.getElementById("playVideo");
        const playText = document.querySelector(".play-text");
        const heroOverlay = document.querySelector(".hero-overlay");
        const iframe = document.getElementById("videoFrame");

        playButton.addEventListener("click", function () {
            // ✅ Hide elements
            heroImage.style.display = "none";
            playButton.style.display = "none";
            playText.style.display = "none";
            heroOverlay.style.display = "none";

            // ✅ Show and autoplay the video
            videoContainer.style.display = "flex";
            let videoSrc = iframe.src;
            if (!videoSrc.includes("autoplay=1")) {
                iframe.src = videoSrc + (videoSrc.includes("?") ? "&" : "?") + "autoplay=1";
            }
        });

        // ✅ FAQ Functionality (Open/Close Answers)
        const faqItems = document.querySelectorAll(".faq-item");

        faqItems.forEach(item => {
            const question = item.querySelector(".faq-question");
            const answer = item.querySelector(".faq-answer");
            const arrow = item.querySelector(".arrow");

            question.addEventListener("click", function () {
                const isActive = answer.style.display === "block";

                // Close all other answers
                faqItems.forEach(faq => {
                    faq.querySelector(".faq-answer").style.display = "none";
                    faq.querySelector(".arrow").textContent = "▼";
                });

                // Toggle clicked item
                answer.style.display = isActive ? "none" : "block";
                arrow.textContent = isActive ? "{% trans '▼' %}" : "{% trans '▲' %}";
            });
        });

        // ✅ Smooth Scroll Function for Navigation
        window.scrollToSection = function (sectionId) {
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                window.scrollTo({
                    top: targetSection.offsetTop - 20, // Adjust for spacing
                    behavior: "smooth"
                });
            }
        };

        // ✅ Floating Chat Button Functionality
        window.toggleChat = function () {
            document.getElementById("chatBox").classList.toggle("show");
        };
    });

</script>

{% endblock %}
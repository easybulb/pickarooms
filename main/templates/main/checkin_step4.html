{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Check-In - Confirm Details" %}{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step completed">
                <span class="step-number">1</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step completed">
                <span class="step-number">2</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step completed">
                <span class="step-number">3</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step active">
                <span class="step-number">4</span>
            </div>
        </div>

        <h1>‚úÖ {% trans "Almost There!" %}</h1>
        <p style="font-size: 14px; color: #ccc; margin-bottom: 20px;">
            {% trans "Please confirm your details before completing check-in." %}
        </p>

        <!-- Summary Box -->
        <div class="summary-box">
            <h3>{% trans "Your Booking Summary" %}</h3>
            
            <div class="summary-item">
                <span class="label">{% trans "Name:" %}</span>
                <span class="value">{{ flow_data.full_name }}</span>
            </div>
            
            <div class="summary-item">
                <span class="label">{% trans "Phone:" %}</span>
                <span class="value">{{ flow_data.phone_number }}</span>
            </div>
            
            {% if flow_data.email %}
            <div class="summary-item">
                <span class="label">{% trans "Email:" %}</span>
                <span class="value">{{ flow_data.email }}</span>
            </div>
            {% endif %}
            
            <div class="summary-item">
                <span class="label">{% trans "Room:" %}</span>
                <span class="value">{{ reservation.room.name }}</span>
            </div>
            
            <div class="summary-item">
                <span class="label">{% trans "Check-In:" %}</span>
                <span class="value">{{ reservation.check_in_date|date:"d M Y" }}</span>
            </div>
            
            <div class="summary-item">
                <span class="label">{% trans "Check-Out:" %}</span>
                <span class="value">{{ reservation.check_out_date|date:"d M Y" }}</span>
            </div>
            
            {% if flow_data.car_registration %}
            <div class="summary-item">
                <span class="label">üöó {% trans "Car Registration:" %}</span>
                <span class="value">{{ flow_data.car_registration }}</span>
            </div>
            {% endif %}
        </div>

        <form method="post" class="checkin-form" id="confirm-form">
            {% csrf_token %}
            
            <!-- GDPR Consent Box -->
            <div class="gdpr-consent-box">
                <h4 style="margin: 0 0 12px 0; color: #FFD700; font-size: 16px; font-weight: 600;">
                    üìã {% trans "Data Privacy & Consent" %}
                </h4>
                <p style="font-size: 13px; color: #f0f0f0; line-height: 1.6; margin: 0 0 15px 0;">
                    {% trans "We use your contact details to:" %}
                </p>
                <ul style="font-size: 13px; color: #ccc; line-height: 1.8; margin: 0 0 15px 20px; padding: 0;">
                    <li>{% trans "Provide your room access PIN" %}</li>
                    <li>{% trans "Send check-in instructions" %}</li>
                    <li>{% trans "Manage your stay and support requests" %}</li>
                </ul>
                <p style="font-size: 12px; color: #aaa; margin: 0 0 15px 0; font-style: italic;">
                    {% trans "Your data is stored securely and can be deleted at any time by contacting us." %}
                </p>
                
                <!-- Consent Checkbox -->
                <label class="consent-label">
                    <input type="checkbox" name="gdpr_consent" id="gdpr_consent" required>
                    <span>
                        {% trans "I agree to the" %}
                        <a href="{% url 'privacy_policy' %}" target="_blank">{% trans "Privacy Policy" %}</a>
                        {% trans "and" %}
                        <a href="{% url 'terms_conditions' %}" target="_blank">{% trans "Terms of Service" %}</a>
                    </span>
                </label>
            </div>
            
            <button type="submit" class="btn-primary" id="confirm-btn" disabled>
                <span id="btn-text">‚úÖ {% trans "Confirm & Complete Check-In" %}</span>
                <span id="btn-loading" style="display: none;">
                    <span class="spinner"></span> {% trans "Processing..." %}
                </span>
            </button>
        </form>

        <!-- Back Link -->
        <p style="margin-top: 15px;">
            <a href="{% url 'checkin_parking' %}" class="back-link">‚Üê {% trans "Back" %}</a>
        </p>

        <!-- PIN Status Indicator (Hidden by default) -->
        <div id="pin-status" style="display: none; margin-top: 20px; padding: 12px; border-radius: 8px; font-size: 14px;">
            <span id="status-icon"></span>
            <span id="status-text"></span>
        </div>
    </div>
    <img src="https://res.cloudinary.com/dkqpb7vwr/image/upload/v1739380781/grey-hero-pickarooms_i5lums.png"
         alt="{% trans 'Luxury Hotel Room' %}" class="hero-image">
</section>

<style>
    /* Progress Bar Styles */
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #fff;
        position: relative;
        transition: all 0.3s ease;
    }

    .step.completed {
        background: #28a745;
        border-color: #28a745;
    }

    .step.active {
        background: #667eea;
        border-color: #667eea;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
    }

    .step .step-number {
        display: block;
    }

    .step.completed .step-number {
        display: none;
    }

    .step .checkmark {
        display: none;
        font-size: 20px;
    }

    .step.completed .checkmark {
        display: block;
    }

    .step-line {
        width: 60px;
        height: 3px;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .step-line.completed {
        background: #28a745;
    }

    /* GDPR Consent Box */
    .gdpr-consent-box {
        background: rgba(255, 215, 0, 0.08);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: left;
    }
    
    .consent-label {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-size: 13px;
        color: #fff;
        cursor: pointer;
        line-height: 1.6;
    }
    
    .consent-label input[type="checkbox"] {
        margin-top: 4px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    .consent-label a {
        color: #FFD700;
        text-decoration: underline;
    }
    
    .consent-label a:hover {
        color: #FFC700;
    }

    /* Summary Box */
    .summary-box {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: left;
    }

    .summary-box h3 {
        margin: 0 0 15px 0;
        color: #FFD700;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 14px;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-item .label {
        color: #ccc;
        font-weight: 500;
    }

    .summary-item .value {
        color: #fff;
        font-weight: 600;
        text-align: right;
    }

    /* Button */
    .btn-primary {
        width: 100%;
        padding: 16px;
        border: none;
        background: linear-gradient(90deg, #28a745, #20c997);
        color: white;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(40, 167, 69, 0.5);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .back-link {
        color: #FFD700;
        text-decoration: none;
        font-size: 14px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    /* Spinner */
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* PIN Status */
    #pin-status {
        animation: fadeIn 0.3s ease;
    }

    #pin-status.success {
        background: rgba(40, 167, 69, 0.2);
        border: 1px solid #28a745;
        color: #28a745;
    }

    #pin-status.error {
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid #dc3545;
        color: #dc3545;
    }

    #pin-status.loading {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid #667eea;
        color: #667eea;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Fix footer overlap - add bottom spacing */
    .hero-content {
        padding-bottom: 100px;
    }

    /* PIN Status positioning */
    #pin-status {
        margin-bottom: 30px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .hero-content {
            padding-bottom: 150px;
        }
        .progress-bar {
            max-width: 100%;
            padding: 0 20px;
        }

        .step {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }

        .step-line {
            width: 40px;
        }

        .hero-content h1 {
            font-size: 2rem;
        }

        .summary-box {
            padding: 15px;
        }

        .summary-item {
            flex-direction: column;
            gap: 5px;
        }

        .summary-item .value {
            text-align: left;
        }
        
        .gdpr-consent-box {
            padding: 15px;
        }
        
        .gdpr-consent-box h4 {
            font-size: 14px;
        }
        
        .gdpr-consent-box p,
        .gdpr-consent-box ul {
            font-size: 12px;
        }

        #pin-status {
            margin-bottom: 40px;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('confirm-form');
        const confirmBtn = document.getElementById('confirm-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const pinStatus = document.getElementById('pin-status');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const gdprCheckbox = document.getElementById('gdpr_consent');
        
        let pinReady = false; // Track if PIN is ready
        
        // GDPR Checkbox - Enable button only when both PIN ready AND consent checked
        gdprCheckbox.addEventListener('change', function() {
            updateButtonState();
        });
        
        function updateButtonState() {
            if (pinReady && gdprCheckbox.checked) {
                confirmBtn.disabled = false;
            } else {
                confirmBtn.disabled = true;
            }
        }

        // Check PIN status on page load
        checkPinStatus();

        function checkPinStatus() {
            fetch('/checkin/pin-status/')
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        // ‚úÖ PIN is ready!
                        pinReady = true;
                        pinStatus.style.display = 'block';
                        pinStatus.className = 'success';
                        statusIcon.textContent = '‚úÖ ';
                        statusText.textContent = '{% trans "Your access PIN is ready! Please accept the privacy terms below to continue." %}';
                        updateButtonState();
                    } else if (data.failed) {
                        // ‚ùå PIN generation failed
                        pinStatus.style.display = 'block';
                        pinStatus.className = 'error';
                        statusIcon.textContent = '‚ùå ';
                        statusText.textContent = '{% trans "PIN generation failed. You will be redirected to contact support." %}';
                        
                        // Auto-redirect to error page after 2 seconds
                        setTimeout(() => {
                            window.location.href = '/checkin/error/';
                        }, 2000);
                    } else {
                        // ‚è≥ Still generating
                        pinReady = false;
                        pinStatus.style.display = 'block';
                        pinStatus.className = 'loading';
                        statusIcon.innerHTML = '<span class="spinner"></span>';
                        statusText.textContent = '{% trans "Preparing your access PIN... Almost ready!" %}';
                        updateButtonState();
                        
                        // Check again in 1 second
                        setTimeout(checkPinStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking PIN status:', error);
                    // Assume PIN is ready on error (backend will handle validation)
                    pinReady = true;
                    updateButtonState();
                });
        }

        // Form submission
        form.addEventListener('submit', function(e) {
            confirmBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
        });

        // Page enter animation
        document.body.style.opacity = '0';
        setTimeout(() => {
            document.body.style.transition = 'opacity 0.3s ease';
            document.body.style.opacity = '1';
        }, 50);
    });
</script>
{% endblock %}

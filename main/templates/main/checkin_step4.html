{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Check-In - Confirm Details" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkin.css' %}">
{% endblock %}

{% block content %}
<section class="checkin-hero">
    <div class="checkin-content">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step completed">
                <span class="step-number">1</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step completed">
                <span class="step-number">2</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step completed">
                <span class="step-number">3</span>
                <span class="checkmark">‚úì</span>
            </div>
            <div class="step-line completed"></div>
            <div class="step active">
                <span class="step-number">4</span>
            </div>
        </div>

        <h1>‚úÖ {% trans "Almost There!" %}</h1>
        <p>{% trans "Please confirm your details before completing check-in." %}</p>

        <!-- Summary Box -->
        <div class="summary-box">
            <h3>{% trans "Your Booking Summary" %}</h3>

            <div class="summary-item">
                <span class="label">{% trans "Name:" %}</span>
                <span class="value">{{ flow_data.full_name }}</span>
            </div>

            <div class="summary-item">
                <span class="label">{% trans "Phone:" %}</span>
                <span class="value">{{ flow_data.phone_number }}</span>
            </div>

            {% if flow_data.email %}
            <div class="summary-item">
                <span class="label">{% trans "Email:" %}</span>
                <span class="value">{{ flow_data.email }}</span>
            </div>
            {% endif %}

            <div class="summary-item">
                <span class="label">{% trans "Room:" %}</span>
                <span class="value">{{ reservation.room.name }}</span>
            </div>

            <div class="summary-item">
                <span class="label">{% trans "Check-In:" %}</span>
                <span class="value">{{ reservation.check_in_date|date:"d M Y" }}</span>
            </div>

            <div class="summary-item">
                <span class="label">{% trans "Check-Out:" %}</span>
                <span class="value">{{ reservation.check_out_date|date:"d M Y" }}</span>
            </div>

            {% if flow_data.car_registration %}
            <div class="summary-item">
                <span class="label">üöó {% trans "Car Registration:" %}</span>
                <span class="value">{{ flow_data.car_registration }}</span>
            </div>
            {% endif %}
        </div>

        <div class="input-area">
            <form method="post" class="checkin-form" id="confirm-form">
                {% csrf_token %}

                <!-- GDPR Consent Box -->
                <div class="gdpr-consent-box">
                    <h4>üìã {% trans "Data Privacy & Consent" %}</h4>
                    <p style="margin-bottom: 12px;">{% trans "We use your contact details to:" %}</p>
                    <ul style="font-size: 14px; line-height: 1.8; margin: 0 0 15px 20px; padding: 0; color: #44403c;">
                        <li>{% trans "Provide your room access PIN" %}</li>
                        <li>{% trans "Send check-in instructions" %}</li>
                        <li>{% trans "Manage your stay and support requests" %}</li>
                    </ul>
                    <p style="font-size: 12px; color: #78716c; margin: 0 0 15px 0; font-style: italic;">
                        {% trans "Your data is stored securely and can be deleted at any time by contacting us." %}
                    </p>

                    <!-- Consent Checkbox -->
                    <label class="consent-label">
                        <input type="checkbox" name="gdpr_consent" id="gdpr_consent" required>
                        <span>
                            {% trans "I agree to the" %}
                            <a href="{% url 'privacy_policy' %}" target="_blank">{% trans "Privacy Policy" %}</a>
                            {% trans "and" %}
                            <a href="{% url 'terms_conditions' %}" target="_blank">{% trans "Terms of Service" %}</a>
                        </span>
                    </label>
                </div>

                <button type="submit" class="btn-primary" id="confirm-btn" disabled>
                    <span id="btn-text">‚úÖ {% trans "Confirm & Complete Check-In" %}</span>
                    <span id="btn-loading" style="display: none;">
                        <span class="spinner"></span> {% trans "Processing..." %}
                    </span>
                </button>
            </form>
        </div>

        <!-- Back Link -->
        <p style="text-align: center; margin-top: 15px;">
            <a href="{% url 'checkin_parking' %}" class="back-link">‚Üê {% trans "Back" %}</a>
        </p>

        <!-- PIN Status Indicator (Always visible with loading state) -->
        <div id="pin-status" style="margin-top: 20px; padding: 16px; border-radius: 12px; font-size: 14px; background: rgba(255, 255, 255, 0.12); border: 2px solid rgba(255, 255, 255, 0.25);">
            <span id="status-icon"><span class="spinner"></span></span>
            <span id="status-text" style="color: #ffffff;">{% trans "Preparing your access PIN... Almost ready!" %}</span>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const consentCheckbox = document.getElementById('gdpr_consent');
        const confirmBtn = document.getElementById('confirm-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const form = document.getElementById('confirm-form');
        const pinStatus = document.getElementById('pin-status');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        
        let pinReady = false;

        // GDPR Checkbox - Enable button only when both PIN ready AND consent checked
        consentCheckbox.addEventListener('change', function() {
            updateButtonState();
        });
        
        function updateButtonState() {
            if (pinReady && consentCheckbox.checked) {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
                confirmBtn.style.cursor = 'pointer';
            } else {
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.6';
                confirmBtn.style.cursor = 'not-allowed';
            }
        }

        // Show loading state on submit
        form.addEventListener('submit', function() {
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            confirmBtn.disabled = true;
        });

        // Check PIN status on page load
        checkPINStatus();

        function checkPINStatus() {
            fetch('/checkin/pin-status/')
                .then(response => response.json())
                .then(data => {
                    if (data.ready) {
                        // ‚úÖ PIN is ready!
                        pinReady = true;
                        pinStatus.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.06) 100%)';
                        pinStatus.style.borderColor = '#10b981';
                        statusIcon.innerHTML = '‚úÖ ';
                        statusText.textContent = '{% trans "Your access PIN is ready! Please accept the privacy terms below to continue." %}';
                        updateButtonState();
                    } else if (data.failed) {
                        // ‚ùå PIN generation failed
                        pinStatus.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.12) 0%, rgba(239, 68, 68, 0.06) 100%)';
                        pinStatus.style.borderColor = '#ef4444';
                        statusIcon.innerHTML = '‚ùå ';
                        statusText.textContent = '{% trans "PIN generation failed. You will be redirected to contact support." %}';
                        
                        // Auto-redirect to error page after 2 seconds
                        setTimeout(() => {
                            window.location.href = '/checkin/error/';
                        }, 2000);
                    } else {
                        // ‚è≥ Still generating
                        pinReady = false;
                        pinStatus.style.background = 'linear-gradient(135deg, rgba(0, 102, 204, 0.12) 0%, rgba(0, 102, 204, 0.06) 100%)';
                        pinStatus.style.borderColor = '#0066cc';
                        statusIcon.innerHTML = '<span class="spinner"></span>';
                        statusText.textContent = '{% trans "Preparing your access PIN... Almost ready!" %}';
                        updateButtonState();
                        
                        // Check again in 1 second
                        setTimeout(checkPINStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking PIN status:', error);
                    // Assume PIN is ready on error (backend will handle validation)
                    pinReady = true;
                    updateButtonState();
                });
        }
    });
</script>
{% endblock %}
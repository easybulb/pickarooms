{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "All Reservations" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/all_reservations.css' %}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Navigation -->
    <div class="nav-link">
        <a href="{% url 'admin_page' %}" class="nav-link">{% trans "Dashboard" %}</a>
        <a href="{% url 'all_reservations' %}" class="nav-link">{% trans "All Reservations" %}</a>
        <a href="{% url 'pending_enrichments_page' %}" class="nav-link">{% trans "Pending Enrichments" %}</a>
        <a href="{% url 'enrichment_logs_page' %}" class="nav-link">{% trans "Enrichment Logs" %}</a>
        <a href="{% url 'xls_upload_page' %}" class="nav-link">{% trans "XLS Upload" %}</a>
        <a href="{% url 'message_templates' %}" class="nav-link">{% trans "Message Templates" %}</a>
        {% if 'main.can_give_access' in perms %}
            <a href="{% url 'give_access' %}" class="nav-link">{% trans "Open Doors" %}</a>
        {% endif %}
        {% if 'main.manage_rooms' in perms %}
            <a href="{% url 'room_management' %}" class="nav-link">{% trans "Manage Rooms" %}</a>
        {% endif %}
        {% if user.is_superuser %}
            <a href="{% url 'user_management' %}" class="nav-link">{% trans "Manage Admins" %}</a>
            <a href="{% url 'price_suggester' %}" class="nav-link">{% trans "Price Suggester" %}</a>
            <a href="{% url 'audit_logs' %}" class="nav-link">{% trans "Audit Logs" %}</a>
            <a href="{% url 'block_review_messages' %}" class="nav-link">{% trans "Block Review Messages" %}</a>
        {% endif %}
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1>📋 {% trans "All Reservations" %}</h1>
            <p class="page-subtitle">{% trans "View and manage all Booking.com & Airbnb reservations" %}</p>
        </div>
        <div class="view-mode-toggle">
            {% if not show_all and not search_query %}
                <a href="?show_all=true" class="btn btn-secondary">{% trans "Show All (Including Old)" %}</a>
            {% else %}
                <a href="{% url 'all_reservations' %}" class="btn btn-primary">{% trans "Show Default View" %}</a>
            {% endif %}
        </div>
    </div>

    <!-- Info Banner -->
    <div class="info-banner">
        <div class="info-banner-text">
            {% if search_query %}
                <strong>🔍 {% trans "Search Results" %}</strong><br>
                {% trans "Showing all reservations matching:" %} "{{ search_query }}"
            {% elif show_all %}
                <strong>📚 {% trans "All Reservations" %}</strong><br>
                {% trans "Showing all reservations (past, present, future)" %}
            {% else %}
                <strong>✨ {% trans "Default View" %}</strong><br>
                {% trans "Current guests + Upcoming + Recently checked out (last 1 day)" %}
            {% endif %}
        </div>
        <div class="quick-filters">
            <a href="?quick=today" class="btn">{% trans "Today" %}</a>
            <a href="?quick=tomorrow" class="btn">{% trans "Tomorrow" %}</a>
        </div>
    </div>

    <!-- Filter Form -->
    <form method="GET" class="filter-form">
        <div class="filter-grid">
            <div class="filter-group">
                <label for="platform">{% trans "Platform" %}</label>
                <select id="platform" name="platform">
                    <option value="all" {% if platform_filter == 'all' %}selected{% endif %}>{% trans "All Platforms" %}</option>
                    <option value="booking" {% if platform_filter == 'booking' %}selected{% endif %}>{% trans "Booking.com" %}</option>
                    <option value="airbnb" {% if platform_filter == 'airbnb' %}selected{% endif %}>{% trans "Airbnb" %}</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="status">{% trans "Status" %}</label>
                <select id="status" name="status">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>{% trans "All Statuses" %}</option>
                    <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>{% trans "Confirmed" %}</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>{% trans "Cancelled" %}</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="enrichment">{% trans "Enrichment" %}</label>
                <select id="enrichment" name="enrichment">
                    <option value="all" {% if enrichment_filter == 'all' %}selected{% endif %}>{% trans "All" %}</option>
                    <option value="enriched" {% if enrichment_filter == 'enriched' %}selected{% endif %}>{% trans "Enriched" %}</option>
                    <option value="unenriched" {% if enrichment_filter == 'unenriched' %}selected{% endif %}>{% trans "Unenriched" %}</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="search">{% trans "Search" %}</label>
                <input type="text" id="search" name="search" 
                       placeholder="{% trans 'Booking ref or guest name...' %}" 
                       value="{{ search_query }}">
            </div>

            <div class="filter-group">
                <label for="date_from">{% trans "Check-in From" %}</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}">
            </div>

            <div class="filter-group">
                <label for="date_to">{% trans "Check-in To" %}</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}">
            </div>
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">🔍 {% trans "Apply Filters" %}</button>
            <a href="{% url 'all_reservations' %}" class="btn btn-secondary">🔄 {% trans "Clear Filters" %}</a>
        </div>
    </form>

    <!-- Bulk Actions -->
    <div class="bulk-actions" id="bulk-actions" style="display: none;">
        <div class="selection-count">
            <span id="selected-count">0</span> {% trans "reservation(s) selected" %}
        </div>
        <div class="select-controls">
            <button type="button" id="select-all-btn">{% trans "Select All" %}</button>
            <button type="button" id="deselect-all-btn">{% trans "Deselect All" %}</button>
        </div>
        <form method="POST" action="{% url 'bulk_delete_reservations' %}" id="bulk-delete-form" onsubmit="return confirmBulkDelete()">
            {% csrf_token %}
            <div id="selected-ids-container"></div>
            <button type="submit" class="btn btn-danger" id="bulk-delete-btn" disabled>
                🗑️ {% trans "Delete Selected" %}
            </button>
        </form>
    </div>

    <!-- Results Info -->
    <div class="pagination-info">
        <div>
            <strong>{% trans "Total:" %}</strong> <span id="total-count">{{ reservations|length }}</span> {% trans "reservation(s)" %}
        </div>
        <div>
            <strong>{% trans "Showing:" %}</strong> <span id="showing-info">1-25</span>
        </div>
    </div>

    <!-- Reservations Table -->
    <div class="table-container">
        <table class="admin-table" id="reservations-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-header" title="{% trans 'Select all on this page' %}"></th>
                    <th>{% trans "Booking Ref" %}</th>
                    <th>{% trans "Guest Name" %}</th>
                    <th>{% trans "Platform" %}</th>
                    <th>{% trans "Room" %}</th>
                    <th>{% trans "Check-in" %}</th>
                    <th>{% trans "Check-out" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Time" %}</th>
                    <th>{% trans "Enrichment" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody id="reservations-tbody">
                {% for reservation in reservations %}
                <tr class="reservation-row" data-reservation-id="{{ reservation.id }}">
                    <td>
                        {% if not reservation.guest %}
                            <input type="checkbox" class="reservation-checkbox" value="{{ reservation.id }}">
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td><strong>{{ reservation.booking_reference }}</strong></td>
                    <td>
                        {% if reservation.guest %}
                            <strong>{{ reservation.guest.full_name }}</strong>
                        {% else %}
                            {{ reservation.guest_name|default:"—" }}
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.platform == 'booking' %}
                            <span class="platform-badge platform-booking">📘 Booking</span>
                        {% elif reservation.platform == 'airbnb' %}
                            <span class="platform-badge platform-airbnb">🏠 Airbnb</span>
                        {% endif %}
                    </td>
                    <td>{{ reservation.room.name }}</td>
                    <td>
                        {{ reservation.check_in_date|date:"d M Y" }}
                        {% if reservation.early_checkin_time %}
                            <br><small>{{ reservation.early_checkin_time|time:"h:i A" }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {{ reservation.check_out_date|date:"d M Y" }}
                        {% if reservation.late_checkout_time %}
                            <br><small>{{ reservation.late_checkout_time|time:"h:i A" }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.status == 'confirmed' %}
                            <span class="badge badge-confirmed">✓ Confirmed</span>
                        {% elif reservation.status == 'cancelled' %}
                            <span class="badge badge-cancelled">✗ Cancelled</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.check_in_date > today %}
                            <span class="badge badge-upcoming">Upcoming</span>
                        {% elif reservation.check_in_date <= today and reservation.check_out_date >= today %}
                            <span class="badge badge-current">● Current</span>
                        {% else %}
                            <span class="badge badge-past">Past</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.guest %}
                            <span class="badge badge-enriched">✓ Enriched</span>
                        {% else %}
                            <span class="badge badge-unenriched">⚠ Pending</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if reservation.guest %}
                            <a href="{% url 'guest_details' reservation.guest.id %}" class="action-link">{% trans "View" %}</a>
                        {% else %}
                            <a href="{% url 'edit_reservation' reservation.id %}" class="action-link">{% trans "Edit" %}</a>
                            <a href="{% url 'manual_checkin_reservation' reservation.id %}" class="action-link">{% trans "Check In" %}</a>
                            <form method="POST" action="{% url 'delete_reservation' reservation.id %}" style="display: inline;" onsubmit="return confirm('Delete this reservation?');">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn">{% trans "Delete" %}</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="empty-state">
                        <h3>😊 {% trans "No Reservations Found" %}</h3>
                        <p>{% trans "Try adjusting your filters or search query." %}</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination" id="pagination-controls"></div>

    <a href="{% url 'admin_page' %}" class="nav-link">← {% trans "Back to Dashboard" %}</a>
</div>

<script src="{% static 'js/all_reservations.js' %}"></script>
{% endblock %}
